<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tp_Gcs: scipy.optimize._lsq.trf Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Tp_Gcs<span id="projectnumber">&#160;1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacescipy.html">scipy</a></li><li class="navelem"><a class="el" href="namespacescipy_1_1optimize.html">optimize</a></li><li class="navelem"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq.html">_lsq</a></li><li class="navelem"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq_1_1trf.html">trf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">scipy.optimize._lsq.trf Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aa8d2cdb546888ab6c4b62a8f1f39ca1f" id="r_aa8d2cdb546888ab6c4b62a8f1f39ca1f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq_1_1trf.html#aa8d2cdb546888ab6c4b62a8f1f39ca1f">trf</a> (fun, jac, x0, f0, J0, lb, ub, ftol, xtol, gtol, max_nfev, x_scale, loss_function, tr_solver, tr_options, verbose)</td></tr>
<tr class="separator:aa8d2cdb546888ab6c4b62a8f1f39ca1f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab9d05ca686595c6a0bc5745f79b567c5" id="r_ab9d05ca686595c6a0bc5745f79b567c5"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq_1_1trf.html#ab9d05ca686595c6a0bc5745f79b567c5">select_step</a> (<a class="el" href="namespacescipy_1_1optimize_1_1__nonlin.html#a9f63beec99dbf869db2b02f71b2dd31e">x</a>, J_h, diag_h, g_h, p, p_h, <a class="el" href="__lapack__subroutines_8h.html#a4c293bae27b15a76659be28378992185">d</a>, Delta, lb, ub, <a class="el" href="__lapack__subroutines_8h.html#a68abd7cf2689a313136b50c232300582">theta</a>)</td></tr>
<tr class="separator:ab9d05ca686595c6a0bc5745f79b567c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a88ca8d52448cfa333987921f68b240e4" id="r_a88ca8d52448cfa333987921f68b240e4"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq_1_1trf.html#a88ca8d52448cfa333987921f68b240e4">trf_bounds</a> (fun, jac, x0, f0, J0, lb, ub, ftol, xtol, gtol, max_nfev, x_scale, loss_function, tr_solver, tr_options, verbose)</td></tr>
<tr class="separator:a88ca8d52448cfa333987921f68b240e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa21c077c559326718a5ed3269ba01e85" id="r_aa21c077c559326718a5ed3269ba01e85"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacescipy_1_1optimize_1_1__lsq_1_1trf.html#aa21c077c559326718a5ed3269ba01e85">trf_no_bounds</a> (fun, jac, x0, f0, J0, ftol, xtol, gtol, max_nfev, x_scale, loss_function, tr_solver, tr_options, verbose)</td></tr>
<tr class="separator:aa21c077c559326718a5ed3269ba01e85"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><pre class="fragment">Trust Region Reflective algorithm for least-squares optimization.

The algorithm is based on ideas from paper [STIR]_. The main idea is to
account for the presence of the bounds by appropriate scaling of the variables (or,
equivalently, changing a trust-region shape). Let's introduce a vector v:

           | ub[i] - x[i], if g[i] &lt; 0 and ub[i] &lt; np.inf
    v[i] = | x[i] - lb[i], if g[i] &gt; 0 and lb[i] &gt; -np.inf
           | 1,           otherwise

where g is the gradient of a cost function and lb, ub are the bounds. Its
components are distances to the bounds at which the anti-gradient points (if
this distance is finite). Define a scaling matrix D = diag(v**0.5).
First-order optimality conditions can be stated as

    D^2 g(x) = 0.

Meaning that components of the gradient should be zero for strictly interior
variables, and components must point inside the feasible region for variables
on the bound.

Now consider this system of equations as a new optimization problem. If the
point x is strictly interior (not on the bound), then the left-hand side is
differentiable and the Newton step for it satisfies

    (D^2 H + diag(g) Jv) p = -D^2 g

where H is the Hessian matrix (or its J^T J approximation in least squares),
Jv is the Jacobian matrix of v with components -1, 1 or 0, such that all
elements of matrix C = diag(g) Jv are non-negative. Introduce the change
of the variables x = D x_h (_h would be "hat" in LaTeX). In the new variables,
we have a Newton step satisfying

    B_h p_h = -g_h,

where B_h = D H D + C, g_h = D g. In least squares B_h = J_h^T J_h, where
J_h = J D. Note that J_h and g_h are proper Jacobian and gradient with respect
to "hat" variables. To guarantee global convergence we formulate a
trust-region problem based on the Newton step in the new variables:

    0.5 * p_h^T B_h p + g_h^T p_h -&gt; min, ||p_h|| &lt;= Delta

In the original space B = H + D^{-1} C D^{-1}, and the equivalent trust-region
problem is

    0.5 * p^T B p + g^T p -&gt; min, ||D^{-1} p|| &lt;= Delta

Here, the meaning of the matrix D becomes more clear: it alters the shape
of a trust-region, such that large steps towards the bounds are not allowed.
In the implementation, the trust-region problem is solved in "hat" space,
but handling of the bounds is done in the original space (see below and read
the code).

The introduction of the matrix D doesn't allow to ignore bounds, the algorithm
must keep iterates strictly feasible (to satisfy aforementioned
differentiability), the parameter theta controls step back from the boundary
(see the code for details).

The algorithm does another important trick. If the trust-region solution
doesn't fit into the bounds, then a reflected (from a firstly encountered
bound) search direction is considered. For motivation and analysis refer to
[STIR]_ paper (and other papers of the authors). In practice, it doesn't need
a lot of justifications, the algorithm simply chooses the best step among
three: a constrained trust-region step, a reflected step and a constrained
Cauchy step (a minimizer along -g_h in "hat" space, or -D^2 g in the original
space).

Another feature is that a trust-region radius control strategy is modified to
account for appearance of the diagonal C matrix (called diag_h in the code).

Note that all described peculiarities are completely gone as we consider
problems without bounds (the algorithm becomes a standard trust-region type
algorithm very similar to ones implemented in MINPACK).

The implementation supports two methods of solving the trust-region problem.
The first, called 'exact', applies SVD on Jacobian and then solves the problem
very accurately using the algorithm described in [JJMore]_. It is not
applicable to large problem. The second, called 'lsmr', uses the 2-D subspace
approach (sometimes called "indefinite dogleg"), where the problem is solved
in a subspace spanned by the gradient and the approximate Gauss-Newton step
found by ``scipy.sparse.linalg.lsmr``. A 2-D trust-region problem is
reformulated as a 4th order algebraic equation and solved very accurately by
``numpy.roots``. The subspace approach allows to solve very large problems
(up to couple of millions of residuals on a regular PC), provided the Jacobian
matrix is sufficiently sparse.

References
----------
.. [STIR] Branch, M.A., T.F. Coleman, and Y. Li, "A Subspace, Interior,
      and Conjugate Gradient Method for Large-Scale Bound-Constrained
      Minimization Problems," SIAM Journal on Scientific Computing,
      Vol. 21, Number 1, pp 1-23, 1999.
.. [JJMore] More, J. J., "The Levenberg-Marquardt Algorithm: Implementation
    and Theory," Numerical Analysis, ed. G. A. Watson, Lecture
</pre> </div><h2 class="groupheader">Function Documentation</h2>
<a id="ab9d05ca686595c6a0bc5745f79b567c5" name="ab9d05ca686595c6a0bc5745f79b567c5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab9d05ca686595c6a0bc5745f79b567c5">&#9670;&#160;</a></span>select_step()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">scipy.optimize._lsq.trf.select_step </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>J_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>diag_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>g_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>p_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>Delta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>lb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>theta</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Select the best step according to Trust Region Reflective algorithm.</pre> <div class="fragment"><div class="line"><span class="lineno">  128</span><span class="keyword">def </span>select_step(x, J_h, diag_h, g_h, p, p_h, d, Delta, lb, ub, theta):</div>
<div class="line"><span class="lineno">  129</span>    <span class="stringliteral">&quot;&quot;&quot;Select the best step according to Trust Region Reflective algorithm.&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  130</span>    <span class="keywordflow">if</span> in_bounds(x + p, lb, ub):</div>
<div class="line"><span class="lineno">  131</span>        p_value = evaluate_quadratic(J_h, g_h, p_h, diag=diag_h)</div>
<div class="line"><span class="lineno">  132</span>        <span class="keywordflow">return</span> p, p_h, -p_value</div>
<div class="line"><span class="lineno">  133</span> </div>
<div class="line"><span class="lineno">  134</span>    p_stride, hits = step_size_to_bound(x, p, lb, ub)</div>
<div class="line"><span class="lineno">  135</span> </div>
<div class="line"><span class="lineno">  136</span>    <span class="comment"># Compute the reflected direction.</span></div>
<div class="line"><span class="lineno">  137</span>    r_h = np.copy(p_h)</div>
<div class="line"><span class="lineno">  138</span>    r_h[hits.astype(bool)] *= -1</div>
<div class="line"><span class="lineno">  139</span>    r = d * r_h</div>
<div class="line"><span class="lineno">  140</span> </div>
<div class="line"><span class="lineno">  141</span>    <span class="comment"># Restrict trust-region step, such that it hits the bound.</span></div>
<div class="line"><span class="lineno">  142</span>    p *= p_stride</div>
<div class="line"><span class="lineno">  143</span>    p_h *= p_stride</div>
<div class="line"><span class="lineno">  144</span>    x_on_bound = x + p</div>
<div class="line"><span class="lineno">  145</span> </div>
<div class="line"><span class="lineno">  146</span>    <span class="comment"># Reflected direction will cross first either feasible region or trust</span></div>
<div class="line"><span class="lineno">  147</span>    <span class="comment"># region boundary.</span></div>
<div class="line"><span class="lineno">  148</span>    _, to_tr = intersect_trust_region(p_h, r_h, Delta)</div>
<div class="line"><span class="lineno">  149</span>    to_bound, _ = step_size_to_bound(x_on_bound, r, lb, ub)</div>
<div class="line"><span class="lineno">  150</span> </div>
<div class="line"><span class="lineno">  151</span>    <span class="comment"># Find lower and upper bounds on a step size along the reflected</span></div>
<div class="line"><span class="lineno">  152</span>    <span class="comment"># direction, considering the strict feasibility requirement. There is no</span></div>
<div class="line"><span class="lineno">  153</span>    <span class="comment"># single correct way to do that, the chosen approach seems to work best</span></div>
<div class="line"><span class="lineno">  154</span>    <span class="comment"># on test problems.</span></div>
<div class="line"><span class="lineno">  155</span>    r_stride = min(to_bound, to_tr)</div>
<div class="line"><span class="lineno">  156</span>    <span class="keywordflow">if</span> r_stride &gt; 0:</div>
<div class="line"><span class="lineno">  157</span>        r_stride_l = (1 - theta) * p_stride / r_stride</div>
<div class="line"><span class="lineno">  158</span>        <span class="keywordflow">if</span> r_stride == to_bound:</div>
<div class="line"><span class="lineno">  159</span>            r_stride_u = theta * to_bound</div>
<div class="line"><span class="lineno">  160</span>        <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  161</span>            r_stride_u = to_tr</div>
<div class="line"><span class="lineno">  162</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  163</span>        r_stride_l = 0</div>
<div class="line"><span class="lineno">  164</span>        r_stride_u = -1</div>
<div class="line"><span class="lineno">  165</span> </div>
<div class="line"><span class="lineno">  166</span>    <span class="comment"># Check if reflection step is available.</span></div>
<div class="line"><span class="lineno">  167</span>    <span class="keywordflow">if</span> r_stride_l &lt;= r_stride_u:</div>
<div class="line"><span class="lineno">  168</span>        a, b, c = build_quadratic_1d(J_h, g_h, r_h, s0=p_h, diag=diag_h)</div>
<div class="line"><span class="lineno">  169</span>        r_stride, r_value = minimize_quadratic_1d(</div>
<div class="line"><span class="lineno">  170</span>            a, b, r_stride_l, r_stride_u, c=c)</div>
<div class="line"><span class="lineno">  171</span>        r_h *= r_stride</div>
<div class="line"><span class="lineno">  172</span>        r_h += p_h</div>
<div class="line"><span class="lineno">  173</span>        r = r_h * d</div>
<div class="line"><span class="lineno">  174</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  175</span>        r_value = np.inf</div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>    <span class="comment"># Now correct p_h to make it strictly interior.</span></div>
<div class="line"><span class="lineno">  178</span>    p *= theta</div>
<div class="line"><span class="lineno">  179</span>    p_h *= theta</div>
<div class="line"><span class="lineno">  180</span>    p_value = evaluate_quadratic(J_h, g_h, p_h, diag=diag_h)</div>
<div class="line"><span class="lineno">  181</span> </div>
<div class="line"><span class="lineno">  182</span>    ag_h = -g_h</div>
<div class="line"><span class="lineno">  183</span>    ag = d * ag_h</div>
<div class="line"><span class="lineno">  184</span> </div>
<div class="line"><span class="lineno">  185</span>    to_tr = Delta / norm(ag_h)</div>
<div class="line"><span class="lineno">  186</span>    to_bound, _ = step_size_to_bound(x, ag, lb, ub)</div>
<div class="line"><span class="lineno">  187</span>    <span class="keywordflow">if</span> to_bound &lt; to_tr:</div>
<div class="line"><span class="lineno">  188</span>        ag_stride = theta * to_bound</div>
<div class="line"><span class="lineno">  189</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  190</span>        ag_stride = to_tr</div>
<div class="line"><span class="lineno">  191</span> </div>
<div class="line"><span class="lineno">  192</span>    a, b = build_quadratic_1d(J_h, g_h, ag_h, diag=diag_h)</div>
<div class="line"><span class="lineno">  193</span>    ag_stride, ag_value = minimize_quadratic_1d(a, b, 0, ag_stride)</div>
<div class="line"><span class="lineno">  194</span>    ag_h *= ag_stride</div>
<div class="line"><span class="lineno">  195</span>    ag *= ag_stride</div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span>    <span class="keywordflow">if</span> p_value &lt; r_value <span class="keywordflow">and</span> p_value &lt; ag_value:</div>
<div class="line"><span class="lineno">  198</span>        <span class="keywordflow">return</span> p, p_h, -p_value</div>
<div class="line"><span class="lineno">  199</span>    <span class="keywordflow">elif</span> r_value &lt; p_value <span class="keywordflow">and</span> r_value &lt; ag_value:</div>
<div class="line"><span class="lineno">  200</span>        <span class="keywordflow">return</span> r, r_h, -r_value</div>
<div class="line"><span class="lineno">  201</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  202</span>        <span class="keywordflow">return</span> ag, ag_h, -ag_value</div>
<div class="line"><span class="lineno">  203</span> </div>
<div class="line"><span class="lineno">  204</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="aa8d2cdb546888ab6c4b62a8f1f39ca1f" name="aa8d2cdb546888ab6c4b62a8f1f39ca1f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa8d2cdb546888ab6c4b62a8f1f39ca1f">&#9670;&#160;</a></span>trf()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">scipy.optimize._lsq.trf.trf </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>fun</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>jac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>f0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>J0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>lb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ftol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>xtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>gtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>max_nfev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>loss_function</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_solver</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>verbose</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  113</span>        loss_function, tr_solver, tr_options, verbose):</div>
<div class="line"><span class="lineno">  114</span>    <span class="comment"># For efficiency, it makes sense to run the simplified version of the</span></div>
<div class="line"><span class="lineno">  115</span>    <span class="comment"># algorithm when no bounds are imposed. We decided to write the two</span></div>
<div class="line"><span class="lineno">  116</span>    <span class="comment"># separate functions. It violates the DRY principle, but the individual</span></div>
<div class="line"><span class="lineno">  117</span>    <span class="comment"># functions are kept the most readable.</span></div>
<div class="line"><span class="lineno">  118</span>    <span class="keywordflow">if</span> np.all(lb == -np.inf) <span class="keywordflow">and</span> np.all(ub == np.inf):</div>
<div class="line"><span class="lineno">  119</span>        <span class="keywordflow">return</span> trf_no_bounds(</div>
<div class="line"><span class="lineno">  120</span>            fun, jac, x0, f0, J0, ftol, xtol, gtol, max_nfev, x_scale,</div>
<div class="line"><span class="lineno">  121</span>            loss_function, tr_solver, tr_options, verbose)</div>
<div class="line"><span class="lineno">  122</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  123</span>        <span class="keywordflow">return</span> trf_bounds(</div>
<div class="line"><span class="lineno">  124</span>            fun, jac, x0, f0, J0, lb, ub, ftol, xtol, gtol, max_nfev, x_scale,</div>
<div class="line"><span class="lineno">  125</span>            loss_function, tr_solver, tr_options, verbose)</div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a88ca8d52448cfa333987921f68b240e4" name="a88ca8d52448cfa333987921f68b240e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a88ca8d52448cfa333987921f68b240e4">&#9670;&#160;</a></span>trf_bounds()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">scipy.optimize._lsq.trf.trf_bounds </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>fun</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>jac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>f0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>J0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>lb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ftol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>xtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>gtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>max_nfev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>loss_function</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_solver</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>verbose</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  206</span>               x_scale, loss_function, tr_solver, tr_options, verbose):</div>
<div class="line"><span class="lineno">  207</span>    x = x0.copy()</div>
<div class="line"><span class="lineno">  208</span> </div>
<div class="line"><span class="lineno">  209</span>    f = f0</div>
<div class="line"><span class="lineno">  210</span>    f_true = f.copy()</div>
<div class="line"><span class="lineno">  211</span>    nfev = 1</div>
<div class="line"><span class="lineno">  212</span> </div>
<div class="line"><span class="lineno">  213</span>    J = J0</div>
<div class="line"><span class="lineno">  214</span>    njev = 1</div>
<div class="line"><span class="lineno">  215</span>    m, n = J.shape</div>
<div class="line"><span class="lineno">  216</span> </div>
<div class="line"><span class="lineno">  217</span>    <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  218</span>        rho = loss_function(f)</div>
<div class="line"><span class="lineno">  219</span>        cost = 0.5 * np.sum(rho[0])</div>
<div class="line"><span class="lineno">  220</span>        J, f = scale_for_robust_loss_function(J, f, rho)</div>
<div class="line"><span class="lineno">  221</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  222</span>        cost = 0.5 * np.dot(f, f)</div>
<div class="line"><span class="lineno">  223</span> </div>
<div class="line"><span class="lineno">  224</span>    g = compute_grad(J, f)</div>
<div class="line"><span class="lineno">  225</span> </div>
<div class="line"><span class="lineno">  226</span>    jac_scale = isinstance(x_scale, str) <span class="keywordflow">and</span> x_scale == <span class="stringliteral">&#39;jac&#39;</span></div>
<div class="line"><span class="lineno">  227</span>    <span class="keywordflow">if</span> jac_scale:</div>
<div class="line"><span class="lineno">  228</span>        scale, scale_inv = compute_jac_scale(J)</div>
<div class="line"><span class="lineno">  229</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  230</span>        scale, scale_inv = x_scale, 1 / x_scale</div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>    v, dv = CL_scaling_vector(x, g, lb, ub)</div>
<div class="line"><span class="lineno">  233</span>    v[dv != 0] *= scale_inv[dv != 0]</div>
<div class="line"><span class="lineno">  234</span>    Delta = norm(x0 * scale_inv / v**0.5)</div>
<div class="line"><span class="lineno">  235</span>    <span class="keywordflow">if</span> Delta == 0:</div>
<div class="line"><span class="lineno">  236</span>        Delta = 1.0</div>
<div class="line"><span class="lineno">  237</span> </div>
<div class="line"><span class="lineno">  238</span>    g_norm = norm(g * v, ord=np.inf)</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>    f_augmented = np.zeros((m + n))</div>
<div class="line"><span class="lineno">  241</span>    <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;exact&#39;</span>:</div>
<div class="line"><span class="lineno">  242</span>        J_augmented = np.empty((m + n, n))</div>
<div class="line"><span class="lineno">  243</span>    <span class="keywordflow">elif</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  244</span>        reg_term = 0.0</div>
<div class="line"><span class="lineno">  245</span>        regularize = tr_options.pop(<span class="stringliteral">&#39;regularize&#39;</span>, <span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  246</span> </div>
<div class="line"><span class="lineno">  247</span>    <span class="keywordflow">if</span> max_nfev <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  248</span>        max_nfev = x0.size * 100</div>
<div class="line"><span class="lineno">  249</span> </div>
<div class="line"><span class="lineno">  250</span>    alpha = 0.0  <span class="comment"># &quot;Levenberg-Marquardt&quot; parameter</span></div>
<div class="line"><span class="lineno">  251</span> </div>
<div class="line"><span class="lineno">  252</span>    termination_status = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  253</span>    iteration = 0</div>
<div class="line"><span class="lineno">  254</span>    step_norm = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  255</span>    actual_reduction = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  256</span> </div>
<div class="line"><span class="lineno">  257</span>    <span class="keywordflow">if</span> verbose == 2:</div>
<div class="line"><span class="lineno">  258</span>        print_header_nonlinear()</div>
<div class="line"><span class="lineno">  259</span> </div>
<div class="line"><span class="lineno">  260</span>    <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><span class="lineno">  261</span>        v, dv = CL_scaling_vector(x, g, lb, ub)</div>
<div class="line"><span class="lineno">  262</span> </div>
<div class="line"><span class="lineno">  263</span>        g_norm = norm(g * v, ord=np.inf)</div>
<div class="line"><span class="lineno">  264</span>        <span class="keywordflow">if</span> g_norm &lt; gtol:</div>
<div class="line"><span class="lineno">  265</span>            termination_status = 1</div>
<div class="line"><span class="lineno">  266</span> </div>
<div class="line"><span class="lineno">  267</span>        <span class="keywordflow">if</span> verbose == 2:</div>
<div class="line"><span class="lineno">  268</span>            print_iteration_nonlinear(iteration, nfev, cost, actual_reduction,</div>
<div class="line"><span class="lineno">  269</span>                                      step_norm, g_norm)</div>
<div class="line"><span class="lineno">  270</span> </div>
<div class="line"><span class="lineno">  271</span>        <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> nfev == max_nfev:</div>
<div class="line"><span class="lineno">  272</span>            <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  273</span> </div>
<div class="line"><span class="lineno">  274</span>        <span class="comment"># Now compute variables in &quot;hat&quot; space. Here, we also account for</span></div>
<div class="line"><span class="lineno">  275</span>        <span class="comment"># scaling introduced by `x_scale` parameter. This part is a bit tricky,</span></div>
<div class="line"><span class="lineno">  276</span>        <span class="comment"># you have to write down the formulas and see how the trust-region</span></div>
<div class="line"><span class="lineno">  277</span>        <span class="comment"># problem is formulated when the two types of scaling are applied.</span></div>
<div class="line"><span class="lineno">  278</span>        <span class="comment"># The idea is that first we apply `x_scale` and then apply Coleman-Li</span></div>
<div class="line"><span class="lineno">  279</span>        <span class="comment"># approach in the new variables.</span></div>
<div class="line"><span class="lineno">  280</span> </div>
<div class="line"><span class="lineno">  281</span>        <span class="comment"># v is recomputed in the variables after applying `x_scale`, note that</span></div>
<div class="line"><span class="lineno">  282</span>        <span class="comment"># components which were identically 1 not affected.</span></div>
<div class="line"><span class="lineno">  283</span>        v[dv != 0] *= scale_inv[dv != 0]</div>
<div class="line"><span class="lineno">  284</span> </div>
<div class="line"><span class="lineno">  285</span>        <span class="comment"># Here, we apply two types of scaling.</span></div>
<div class="line"><span class="lineno">  286</span>        d = v**0.5 * scale</div>
<div class="line"><span class="lineno">  287</span> </div>
<div class="line"><span class="lineno">  288</span>        <span class="comment"># C = diag(g * scale) Jv</span></div>
<div class="line"><span class="lineno">  289</span>        diag_h = g * dv * scale</div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span>        <span class="comment"># After all this has been done, we continue normally.</span></div>
<div class="line"><span class="lineno">  292</span> </div>
<div class="line"><span class="lineno">  293</span>        <span class="comment"># &quot;hat&quot; gradient.</span></div>
<div class="line"><span class="lineno">  294</span>        g_h = d * g</div>
<div class="line"><span class="lineno">  295</span> </div>
<div class="line"><span class="lineno">  296</span>        f_augmented[:m] = f</div>
<div class="line"><span class="lineno">  297</span>        <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;exact&#39;</span>:</div>
<div class="line"><span class="lineno">  298</span>            J_augmented[:m] = J * d</div>
<div class="line"><span class="lineno">  299</span>            J_h = J_augmented[:m]  <span class="comment"># Memory view.</span></div>
<div class="line"><span class="lineno">  300</span>            J_augmented[m:] = np.diag(diag_h**0.5)</div>
<div class="line"><span class="lineno">  301</span>            U, s, V = svd(J_augmented, full_matrices=<span class="keyword">False</span>)</div>
<div class="line"><span class="lineno">  302</span>            V = V.T</div>
<div class="line"><span class="lineno">  303</span>            uf = U.T.dot(f_augmented)</div>
<div class="line"><span class="lineno">  304</span>        <span class="keywordflow">elif</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  305</span>            J_h = right_multiplied_operator(J, d)</div>
<div class="line"><span class="lineno">  306</span> </div>
<div class="line"><span class="lineno">  307</span>            <span class="keywordflow">if</span> regularize:</div>
<div class="line"><span class="lineno">  308</span>                a, b = build_quadratic_1d(J_h, g_h, -g_h, diag=diag_h)</div>
<div class="line"><span class="lineno">  309</span>                to_tr = Delta / norm(g_h)</div>
<div class="line"><span class="lineno">  310</span>                ag_value = minimize_quadratic_1d(a, b, 0, to_tr)[1]</div>
<div class="line"><span class="lineno">  311</span>                reg_term = -ag_value / Delta**2</div>
<div class="line"><span class="lineno">  312</span> </div>
<div class="line"><span class="lineno">  313</span>            lsmr_op = regularized_lsq_operator(J_h, (diag_h + reg_term)**0.5)</div>
<div class="line"><span class="lineno">  314</span>            gn_h = lsmr(lsmr_op, f_augmented, **tr_options)[0]</div>
<div class="line"><span class="lineno">  315</span>            S = np.vstack((g_h, gn_h)).T</div>
<div class="line"><span class="lineno">  316</span>            S, _ = qr(S, mode=<span class="stringliteral">&#39;economic&#39;</span>)</div>
<div class="line"><span class="lineno">  317</span>            JS = J_h.dot(S)  <span class="comment"># LinearOperator does dot too.</span></div>
<div class="line"><span class="lineno">  318</span>            B_S = np.dot(JS.T, JS) + np.dot(S.T * diag_h, S)</div>
<div class="line"><span class="lineno">  319</span>            g_S = S.T.dot(g_h)</div>
<div class="line"><span class="lineno">  320</span> </div>
<div class="line"><span class="lineno">  321</span>        <span class="comment"># theta controls step back step ratio from the bounds.</span></div>
<div class="line"><span class="lineno">  322</span>        theta = max(0.995, 1 - g_norm)</div>
<div class="line"><span class="lineno">  323</span> </div>
<div class="line"><span class="lineno">  324</span>        actual_reduction = -1</div>
<div class="line"><span class="lineno">  325</span>        <span class="keywordflow">while</span> actual_reduction &lt;= 0 <span class="keywordflow">and</span> nfev &lt; max_nfev:</div>
<div class="line"><span class="lineno">  326</span>            <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;exact&#39;</span>:</div>
<div class="line"><span class="lineno">  327</span>                p_h, alpha, n_iter = solve_lsq_trust_region(</div>
<div class="line"><span class="lineno">  328</span>                    n, m, uf, s, V, Delta, initial_alpha=alpha)</div>
<div class="line"><span class="lineno">  329</span>            <span class="keywordflow">elif</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  330</span>                p_S, _ = solve_trust_region_2d(B_S, g_S, Delta)</div>
<div class="line"><span class="lineno">  331</span>                p_h = S.dot(p_S)</div>
<div class="line"><span class="lineno">  332</span> </div>
<div class="line"><span class="lineno">  333</span>            p = d * p_h  <span class="comment"># Trust-region solution in the original space.</span></div>
<div class="line"><span class="lineno">  334</span>            step, step_h, predicted_reduction = select_step(</div>
<div class="line"><span class="lineno">  335</span>                x, J_h, diag_h, g_h, p, p_h, d, Delta, lb, ub, theta)</div>
<div class="line"><span class="lineno">  336</span> </div>
<div class="line"><span class="lineno">  337</span>            x_new = make_strictly_feasible(x + step, lb, ub, rstep=0)</div>
<div class="line"><span class="lineno">  338</span>            f_new = fun(x_new)</div>
<div class="line"><span class="lineno">  339</span>            nfev += 1</div>
<div class="line"><span class="lineno">  340</span> </div>
<div class="line"><span class="lineno">  341</span>            step_h_norm = norm(step_h)</div>
<div class="line"><span class="lineno">  342</span> </div>
<div class="line"><span class="lineno">  343</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> np.all(np.isfinite(f_new)):</div>
<div class="line"><span class="lineno">  344</span>                Delta = 0.25 * step_h_norm</div>
<div class="line"><span class="lineno">  345</span>                <span class="keywordflow">continue</span></div>
<div class="line"><span class="lineno">  346</span> </div>
<div class="line"><span class="lineno">  347</span>            <span class="comment"># Usual trust-region step quality estimation.</span></div>
<div class="line"><span class="lineno">  348</span>            <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  349</span>                cost_new = loss_function(f_new, cost_only=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  350</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  351</span>                cost_new = 0.5 * np.dot(f_new, f_new)</div>
<div class="line"><span class="lineno">  352</span>            actual_reduction = cost - cost_new</div>
<div class="line"><span class="lineno">  353</span>            Delta_new, ratio = update_tr_radius(</div>
<div class="line"><span class="lineno">  354</span>                Delta, actual_reduction, predicted_reduction,</div>
<div class="line"><span class="lineno">  355</span>                step_h_norm, step_h_norm &gt; 0.95 * Delta)</div>
<div class="line"><span class="lineno">  356</span> </div>
<div class="line"><span class="lineno">  357</span>            step_norm = norm(step)</div>
<div class="line"><span class="lineno">  358</span>            termination_status = check_termination(</div>
<div class="line"><span class="lineno">  359</span>                actual_reduction, cost, step_norm, norm(x), ratio, ftol, xtol)</div>
<div class="line"><span class="lineno">  360</span>            <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  361</span>                <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  362</span> </div>
<div class="line"><span class="lineno">  363</span>            alpha *= Delta / Delta_new</div>
<div class="line"><span class="lineno">  364</span>            Delta = Delta_new</div>
<div class="line"><span class="lineno">  365</span> </div>
<div class="line"><span class="lineno">  366</span>        <span class="keywordflow">if</span> actual_reduction &gt; 0:</div>
<div class="line"><span class="lineno">  367</span>            x = x_new</div>
<div class="line"><span class="lineno">  368</span> </div>
<div class="line"><span class="lineno">  369</span>            f = f_new</div>
<div class="line"><span class="lineno">  370</span>            f_true = f.copy()</div>
<div class="line"><span class="lineno">  371</span> </div>
<div class="line"><span class="lineno">  372</span>            cost = cost_new</div>
<div class="line"><span class="lineno">  373</span> </div>
<div class="line"><span class="lineno">  374</span>            J = jac(x, f)</div>
<div class="line"><span class="lineno">  375</span>            njev += 1</div>
<div class="line"><span class="lineno">  376</span> </div>
<div class="line"><span class="lineno">  377</span>            <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  378</span>                rho = loss_function(f)</div>
<div class="line"><span class="lineno">  379</span>                J, f = scale_for_robust_loss_function(J, f, rho)</div>
<div class="line"><span class="lineno">  380</span> </div>
<div class="line"><span class="lineno">  381</span>            g = compute_grad(J, f)</div>
<div class="line"><span class="lineno">  382</span> </div>
<div class="line"><span class="lineno">  383</span>            <span class="keywordflow">if</span> jac_scale:</div>
<div class="line"><span class="lineno">  384</span>                scale, scale_inv = compute_jac_scale(J, scale_inv)</div>
<div class="line"><span class="lineno">  385</span>        <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  386</span>            step_norm = 0</div>
<div class="line"><span class="lineno">  387</span>            actual_reduction = 0</div>
<div class="line"><span class="lineno">  388</span> </div>
<div class="line"><span class="lineno">  389</span>        iteration += 1</div>
<div class="line"><span class="lineno">  390</span> </div>
<div class="line"><span class="lineno">  391</span>    <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  392</span>        termination_status = 0</div>
<div class="line"><span class="lineno">  393</span> </div>
<div class="line"><span class="lineno">  394</span>    active_mask = find_active_constraints(x, lb, ub, rtol=xtol)</div>
<div class="line"><span class="lineno">  395</span>    <span class="keywordflow">return</span> OptimizeResult(</div>
<div class="line"><span class="lineno">  396</span>        x=x, cost=cost, fun=f_true, jac=J, grad=g, optimality=g_norm,</div>
<div class="line"><span class="lineno">  397</span>        active_mask=active_mask, nfev=nfev, njev=njev,</div>
<div class="line"><span class="lineno">  398</span>        status=termination_status)</div>
<div class="line"><span class="lineno">  399</span> </div>
<div class="line"><span class="lineno">  400</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="aa21c077c559326718a5ed3269ba01e85" name="aa21c077c559326718a5ed3269ba01e85"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa21c077c559326718a5ed3269ba01e85">&#9670;&#160;</a></span>trf_no_bounds()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">scipy.optimize._lsq.trf.trf_no_bounds </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>fun</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>jac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>f0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>J0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>ftol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>xtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>gtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>max_nfev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>x_scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>loss_function</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_solver</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tr_options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>verbose</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  402</span>                  x_scale, loss_function, tr_solver, tr_options, verbose):</div>
<div class="line"><span class="lineno">  403</span>    x = x0.copy()</div>
<div class="line"><span class="lineno">  404</span> </div>
<div class="line"><span class="lineno">  405</span>    f = f0</div>
<div class="line"><span class="lineno">  406</span>    f_true = f.copy()</div>
<div class="line"><span class="lineno">  407</span>    nfev = 1</div>
<div class="line"><span class="lineno">  408</span> </div>
<div class="line"><span class="lineno">  409</span>    J = J0</div>
<div class="line"><span class="lineno">  410</span>    njev = 1</div>
<div class="line"><span class="lineno">  411</span>    m, n = J.shape</div>
<div class="line"><span class="lineno">  412</span> </div>
<div class="line"><span class="lineno">  413</span>    <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  414</span>        rho = loss_function(f)</div>
<div class="line"><span class="lineno">  415</span>        cost = 0.5 * np.sum(rho[0])</div>
<div class="line"><span class="lineno">  416</span>        J, f = scale_for_robust_loss_function(J, f, rho)</div>
<div class="line"><span class="lineno">  417</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  418</span>        cost = 0.5 * np.dot(f, f)</div>
<div class="line"><span class="lineno">  419</span> </div>
<div class="line"><span class="lineno">  420</span>    g = compute_grad(J, f)</div>
<div class="line"><span class="lineno">  421</span> </div>
<div class="line"><span class="lineno">  422</span>    jac_scale = isinstance(x_scale, str) <span class="keywordflow">and</span> x_scale == <span class="stringliteral">&#39;jac&#39;</span></div>
<div class="line"><span class="lineno">  423</span>    <span class="keywordflow">if</span> jac_scale:</div>
<div class="line"><span class="lineno">  424</span>        scale, scale_inv = compute_jac_scale(J)</div>
<div class="line"><span class="lineno">  425</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  426</span>        scale, scale_inv = x_scale, 1 / x_scale</div>
<div class="line"><span class="lineno">  427</span> </div>
<div class="line"><span class="lineno">  428</span>    Delta = norm(x0 * scale_inv)</div>
<div class="line"><span class="lineno">  429</span>    <span class="keywordflow">if</span> Delta == 0:</div>
<div class="line"><span class="lineno">  430</span>        Delta = 1.0</div>
<div class="line"><span class="lineno">  431</span> </div>
<div class="line"><span class="lineno">  432</span>    <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  433</span>        reg_term = 0</div>
<div class="line"><span class="lineno">  434</span>        damp = tr_options.pop(<span class="stringliteral">&#39;damp&#39;</span>, 0.0)</div>
<div class="line"><span class="lineno">  435</span>        regularize = tr_options.pop(<span class="stringliteral">&#39;regularize&#39;</span>, <span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  436</span> </div>
<div class="line"><span class="lineno">  437</span>    <span class="keywordflow">if</span> max_nfev <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  438</span>        max_nfev = x0.size * 100</div>
<div class="line"><span class="lineno">  439</span> </div>
<div class="line"><span class="lineno">  440</span>    alpha = 0.0  <span class="comment"># &quot;Levenberg-Marquardt&quot; parameter</span></div>
<div class="line"><span class="lineno">  441</span> </div>
<div class="line"><span class="lineno">  442</span>    termination_status = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  443</span>    iteration = 0</div>
<div class="line"><span class="lineno">  444</span>    step_norm = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  445</span>    actual_reduction = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  446</span> </div>
<div class="line"><span class="lineno">  447</span>    <span class="keywordflow">if</span> verbose == 2:</div>
<div class="line"><span class="lineno">  448</span>        print_header_nonlinear()</div>
<div class="line"><span class="lineno">  449</span> </div>
<div class="line"><span class="lineno">  450</span>    <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><span class="lineno">  451</span>        g_norm = norm(g, ord=np.inf)</div>
<div class="line"><span class="lineno">  452</span>        <span class="keywordflow">if</span> g_norm &lt; gtol:</div>
<div class="line"><span class="lineno">  453</span>            termination_status = 1</div>
<div class="line"><span class="lineno">  454</span> </div>
<div class="line"><span class="lineno">  455</span>        <span class="keywordflow">if</span> verbose == 2:</div>
<div class="line"><span class="lineno">  456</span>            print_iteration_nonlinear(iteration, nfev, cost, actual_reduction,</div>
<div class="line"><span class="lineno">  457</span>                                      step_norm, g_norm)</div>
<div class="line"><span class="lineno">  458</span> </div>
<div class="line"><span class="lineno">  459</span>        <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> nfev == max_nfev:</div>
<div class="line"><span class="lineno">  460</span>            <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  461</span> </div>
<div class="line"><span class="lineno">  462</span>        d = scale</div>
<div class="line"><span class="lineno">  463</span>        g_h = d * g</div>
<div class="line"><span class="lineno">  464</span> </div>
<div class="line"><span class="lineno">  465</span>        <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;exact&#39;</span>:</div>
<div class="line"><span class="lineno">  466</span>            J_h = J * d</div>
<div class="line"><span class="lineno">  467</span>            U, s, V = svd(J_h, full_matrices=<span class="keyword">False</span>)</div>
<div class="line"><span class="lineno">  468</span>            V = V.T</div>
<div class="line"><span class="lineno">  469</span>            uf = U.T.dot(f)</div>
<div class="line"><span class="lineno">  470</span>        <span class="keywordflow">elif</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  471</span>            J_h = right_multiplied_operator(J, d)</div>
<div class="line"><span class="lineno">  472</span> </div>
<div class="line"><span class="lineno">  473</span>            <span class="keywordflow">if</span> regularize:</div>
<div class="line"><span class="lineno">  474</span>                a, b = build_quadratic_1d(J_h, g_h, -g_h)</div>
<div class="line"><span class="lineno">  475</span>                to_tr = Delta / norm(g_h)</div>
<div class="line"><span class="lineno">  476</span>                ag_value = minimize_quadratic_1d(a, b, 0, to_tr)[1]</div>
<div class="line"><span class="lineno">  477</span>                reg_term = -ag_value / Delta**2</div>
<div class="line"><span class="lineno">  478</span> </div>
<div class="line"><span class="lineno">  479</span>            damp_full = (damp**2 + reg_term)**0.5</div>
<div class="line"><span class="lineno">  480</span>            gn_h = lsmr(J_h, f, damp=damp_full, **tr_options)[0]</div>
<div class="line"><span class="lineno">  481</span>            S = np.vstack((g_h, gn_h)).T</div>
<div class="line"><span class="lineno">  482</span>            S, _ = qr(S, mode=<span class="stringliteral">&#39;economic&#39;</span>)</div>
<div class="line"><span class="lineno">  483</span>            JS = J_h.dot(S)</div>
<div class="line"><span class="lineno">  484</span>            B_S = np.dot(JS.T, JS)</div>
<div class="line"><span class="lineno">  485</span>            g_S = S.T.dot(g_h)</div>
<div class="line"><span class="lineno">  486</span> </div>
<div class="line"><span class="lineno">  487</span>        actual_reduction = -1</div>
<div class="line"><span class="lineno">  488</span>        <span class="keywordflow">while</span> actual_reduction &lt;= 0 <span class="keywordflow">and</span> nfev &lt; max_nfev:</div>
<div class="line"><span class="lineno">  489</span>            <span class="keywordflow">if</span> tr_solver == <span class="stringliteral">&#39;exact&#39;</span>:</div>
<div class="line"><span class="lineno">  490</span>                step_h, alpha, n_iter = solve_lsq_trust_region(</div>
<div class="line"><span class="lineno">  491</span>                    n, m, uf, s, V, Delta, initial_alpha=alpha)</div>
<div class="line"><span class="lineno">  492</span>            <span class="keywordflow">elif</span> tr_solver == <span class="stringliteral">&#39;lsmr&#39;</span>:</div>
<div class="line"><span class="lineno">  493</span>                p_S, _ = solve_trust_region_2d(B_S, g_S, Delta)</div>
<div class="line"><span class="lineno">  494</span>                step_h = S.dot(p_S)</div>
<div class="line"><span class="lineno">  495</span> </div>
<div class="line"><span class="lineno">  496</span>            predicted_reduction = -evaluate_quadratic(J_h, g_h, step_h)</div>
<div class="line"><span class="lineno">  497</span>            step = d * step_h</div>
<div class="line"><span class="lineno">  498</span>            x_new = x + step</div>
<div class="line"><span class="lineno">  499</span>            f_new = fun(x_new)</div>
<div class="line"><span class="lineno">  500</span>            nfev += 1</div>
<div class="line"><span class="lineno">  501</span> </div>
<div class="line"><span class="lineno">  502</span>            step_h_norm = norm(step_h)</div>
<div class="line"><span class="lineno">  503</span> </div>
<div class="line"><span class="lineno">  504</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> np.all(np.isfinite(f_new)):</div>
<div class="line"><span class="lineno">  505</span>                Delta = 0.25 * step_h_norm</div>
<div class="line"><span class="lineno">  506</span>                <span class="keywordflow">continue</span></div>
<div class="line"><span class="lineno">  507</span> </div>
<div class="line"><span class="lineno">  508</span>            <span class="comment"># Usual trust-region step quality estimation.</span></div>
<div class="line"><span class="lineno">  509</span>            <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  510</span>                cost_new = loss_function(f_new, cost_only=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  511</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  512</span>                cost_new = 0.5 * np.dot(f_new, f_new)</div>
<div class="line"><span class="lineno">  513</span>            actual_reduction = cost - cost_new</div>
<div class="line"><span class="lineno">  514</span> </div>
<div class="line"><span class="lineno">  515</span>            Delta_new, ratio = update_tr_radius(</div>
<div class="line"><span class="lineno">  516</span>                Delta, actual_reduction, predicted_reduction,</div>
<div class="line"><span class="lineno">  517</span>                step_h_norm, step_h_norm &gt; 0.95 * Delta)</div>
<div class="line"><span class="lineno">  518</span> </div>
<div class="line"><span class="lineno">  519</span>            step_norm = norm(step)</div>
<div class="line"><span class="lineno">  520</span>            termination_status = check_termination(</div>
<div class="line"><span class="lineno">  521</span>                actual_reduction, cost, step_norm, norm(x), ratio, ftol, xtol)</div>
<div class="line"><span class="lineno">  522</span>            <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  523</span>                <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  524</span> </div>
<div class="line"><span class="lineno">  525</span>            alpha *= Delta / Delta_new</div>
<div class="line"><span class="lineno">  526</span>            Delta = Delta_new</div>
<div class="line"><span class="lineno">  527</span> </div>
<div class="line"><span class="lineno">  528</span>        <span class="keywordflow">if</span> actual_reduction &gt; 0:</div>
<div class="line"><span class="lineno">  529</span>            x = x_new</div>
<div class="line"><span class="lineno">  530</span> </div>
<div class="line"><span class="lineno">  531</span>            f = f_new</div>
<div class="line"><span class="lineno">  532</span>            f_true = f.copy()</div>
<div class="line"><span class="lineno">  533</span> </div>
<div class="line"><span class="lineno">  534</span>            cost = cost_new</div>
<div class="line"><span class="lineno">  535</span> </div>
<div class="line"><span class="lineno">  536</span>            J = jac(x, f)</div>
<div class="line"><span class="lineno">  537</span>            njev += 1</div>
<div class="line"><span class="lineno">  538</span> </div>
<div class="line"><span class="lineno">  539</span>            <span class="keywordflow">if</span> loss_function <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  540</span>                rho = loss_function(f)</div>
<div class="line"><span class="lineno">  541</span>                J, f = scale_for_robust_loss_function(J, f, rho)</div>
<div class="line"><span class="lineno">  542</span> </div>
<div class="line"><span class="lineno">  543</span>            g = compute_grad(J, f)</div>
<div class="line"><span class="lineno">  544</span> </div>
<div class="line"><span class="lineno">  545</span>            <span class="keywordflow">if</span> jac_scale:</div>
<div class="line"><span class="lineno">  546</span>                scale, scale_inv = compute_jac_scale(J, scale_inv)</div>
<div class="line"><span class="lineno">  547</span>        <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  548</span>            step_norm = 0</div>
<div class="line"><span class="lineno">  549</span>            actual_reduction = 0</div>
<div class="line"><span class="lineno">  550</span> </div>
<div class="line"><span class="lineno">  551</span>        iteration += 1</div>
<div class="line"><span class="lineno">  552</span> </div>
<div class="line"><span class="lineno">  553</span>    <span class="keywordflow">if</span> termination_status <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  554</span>        termination_status = 0</div>
<div class="line"><span class="lineno">  555</span> </div>
<div class="line"><span class="lineno">  556</span>    active_mask = np.zeros_like(x)</div>
<div class="line"><span class="lineno">  557</span>    <span class="keywordflow">return</span> OptimizeResult(</div>
<div class="line"><span class="lineno">  558</span>        x=x, cost=cost, fun=f_true, jac=J, grad=g, optimality=g_norm,</div>
<div class="line"><span class="lineno">  559</span>        active_mask=active_mask, nfev=nfev, njev=njev,</div>
<div class="line"><span class="lineno">  560</span>        status=termination_status)</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
