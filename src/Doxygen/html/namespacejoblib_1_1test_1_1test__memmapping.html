<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tp_Gcs: joblib.test.test_memmapping Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Tp_Gcs<span id="projectnumber">&#160;1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacejoblib.html">joblib</a></li><li class="navelem"><a class="el" href="namespacejoblib_1_1test.html">test</a></li><li class="navelem"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html">test_memmapping</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">joblib.test.test_memmapping Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aa9a776b36f43359e16e59ee5e35c2bea" id="r_aa9a776b36f43359e16e59ee5e35c2bea"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aa9a776b36f43359e16e59ee5e35c2bea">setup_module</a> ()</td></tr>
<tr class="separator:aa9a776b36f43359e16e59ee5e35c2bea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf0ecd54bd0ffb627700935108783d6a" id="r_abf0ecd54bd0ffb627700935108783d6a"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#abf0ecd54bd0ffb627700935108783d6a">teardown_module</a> ()</td></tr>
<tr class="separator:abf0ecd54bd0ffb627700935108783d6a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a12f9323317a15713d6a9db70e19562bb" id="r_a12f9323317a15713d6a9db70e19562bb"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a12f9323317a15713d6a9db70e19562bb">check_memmap_and_send_back</a> (array)</td></tr>
<tr class="separator:a12f9323317a15713d6a9db70e19562bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a276dc8cd54c8a2295ef5c4e645ae5266" id="r_a276dc8cd54c8a2295ef5c4e645ae5266"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a276dc8cd54c8a2295ef5c4e645ae5266">check_array</a> (args)</td></tr>
<tr class="separator:a276dc8cd54c8a2295ef5c4e645ae5266"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab06b583152ef75629a785832b74544a0" id="r_ab06b583152ef75629a785832b74544a0"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#ab06b583152ef75629a785832b74544a0">inplace_double</a> (args)</td></tr>
<tr class="separator:ab06b583152ef75629a785832b74544a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a782913b56aaee94e0b03429d0d6c3c98" id="r_a782913b56aaee94e0b03429d0d6c3c98"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a782913b56aaee94e0b03429d0d6c3c98">test_memmap_based_array_reducing</a> (tmpdir)</td></tr>
<tr class="separator:a782913b56aaee94e0b03429d0d6c3c98"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1cafded09be6cd4ae23b365fa987acf4" id="r_a1cafded09be6cd4ae23b365fa987acf4"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a1cafded09be6cd4ae23b365fa987acf4">test_resource_tracker_retries_when_permissionerror</a> (tmpdir)</td></tr>
<tr class="separator:a1cafded09be6cd4ae23b365fa987acf4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a358edab92a5e6568713b69acc9fa02a9" id="r_a358edab92a5e6568713b69acc9fa02a9"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a358edab92a5e6568713b69acc9fa02a9">test_high_dimension_memmap_array_reducing</a> (tmpdir)</td></tr>
<tr class="separator:a358edab92a5e6568713b69acc9fa02a9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a07dd9c9d27a91406c20c2ac6939df7ec" id="r_a07dd9c9d27a91406c20c2ac6939df7ec"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a07dd9c9d27a91406c20c2ac6939df7ec">test__strided_from_memmap</a> (tmpdir)</td></tr>
<tr class="separator:a07dd9c9d27a91406c20c2ac6939df7ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2fc78072ce9fe3799ef3ffc3ee722e31" id="r_a2fc78072ce9fe3799ef3ffc3ee722e31"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a2fc78072ce9fe3799ef3ffc3ee722e31">test_pool_with_memmap</a> (factory, tmpdir)</td></tr>
<tr class="separator:a2fc78072ce9fe3799ef3ffc3ee722e31"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2a2ea79ed9eeead00a1f4f102f72399e" id="r_a2a2ea79ed9eeead00a1f4f102f72399e"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a2a2ea79ed9eeead00a1f4f102f72399e">test_pool_with_memmap_array_view</a> (factory, tmpdir)</td></tr>
<tr class="separator:a2a2ea79ed9eeead00a1f4f102f72399e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca45de4ba625362ecc90d133f85f3ea4" id="r_aca45de4ba625362ecc90d133f85f3ea4"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aca45de4ba625362ecc90d133f85f3ea4">test_permission_error_windows_reference_cycle</a> (backend)</td></tr>
<tr class="separator:aca45de4ba625362ecc90d133f85f3ea4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad9462252ffb1edceac92d04b977734c" id="r_aad9462252ffb1edceac92d04b977734c"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aad9462252ffb1edceac92d04b977734c">test_permission_error_windows_memmap_sent_to_parent</a> (backend)</td></tr>
<tr class="separator:aad9462252ffb1edceac92d04b977734c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e1b3d4371cdf6cc2b68a4aedb416a5f" id="r_a3e1b3d4371cdf6cc2b68a4aedb416a5f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a3e1b3d4371cdf6cc2b68a4aedb416a5f">test_parallel_isolated_temp_folders</a> (backend)</td></tr>
<tr class="separator:a3e1b3d4371cdf6cc2b68a4aedb416a5f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68e41ef783161ffc54f4234929af7500" id="r_a68e41ef783161ffc54f4234929af7500"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a68e41ef783161ffc54f4234929af7500">test_managed_backend_reuse_temp_folder</a> (backend)</td></tr>
<tr class="separator:a68e41ef783161ffc54f4234929af7500"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a435d887373a2cc185297c063a3d2edc9" id="r_a435d887373a2cc185297c063a3d2edc9"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a435d887373a2cc185297c063a3d2edc9">test_memmapping_temp_folder_thread_safety</a> ()</td></tr>
<tr class="separator:a435d887373a2cc185297c063a3d2edc9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1749b73a6584eac4641671f8f9946d7a" id="r_a1749b73a6584eac4641671f8f9946d7a"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a1749b73a6584eac4641671f8f9946d7a">test_multithreaded_parallel_termination_resource_tracker_silent</a> ()</td></tr>
<tr class="separator:a1749b73a6584eac4641671f8f9946d7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7e84761c2c738996901e20737cbf9c69" id="r_a7e84761c2c738996901e20737cbf9c69"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a7e84761c2c738996901e20737cbf9c69">test_many_parallel_calls_on_same_object</a> (backend)</td></tr>
<tr class="separator:a7e84761c2c738996901e20737cbf9c69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32bf4cf600632810385a9a3006ce5e57" id="r_a32bf4cf600632810385a9a3006ce5e57"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a32bf4cf600632810385a9a3006ce5e57">test_memmap_returned_as_regular_array</a> (backend)</td></tr>
<tr class="separator:a32bf4cf600632810385a9a3006ce5e57"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a766889a41bcf3cefbac5524285d73b0e" id="r_a766889a41bcf3cefbac5524285d73b0e"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a766889a41bcf3cefbac5524285d73b0e">test_resource_tracker_silent_when_reference_cycles</a> (backend)</td></tr>
<tr class="separator:a766889a41bcf3cefbac5524285d73b0e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa44b865da5b0460467933632d42e55a7" id="r_aa44b865da5b0460467933632d42e55a7"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aa44b865da5b0460467933632d42e55a7">test_memmapping_pool_for_large_arrays</a> (factory, tmpdir)</td></tr>
<tr class="separator:aa44b865da5b0460467933632d42e55a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa0cceace3e40184df8cdd07519f33812" id="r_aa0cceace3e40184df8cdd07519f33812"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aa0cceace3e40184df8cdd07519f33812">test_child_raises_parent_exits_cleanly</a> (backend)</td></tr>
<tr class="separator:aa0cceace3e40184df8cdd07519f33812"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2c36922b42abf2300071b97d9db4d252" id="r_a2c36922b42abf2300071b97d9db4d252"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a2c36922b42abf2300071b97d9db4d252">test_memmapping_pool_for_large_arrays_disabled</a> (factory, tmpdir)</td></tr>
<tr class="separator:a2c36922b42abf2300071b97d9db4d252"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a474d79ff81757b0798c498f7e8c9eab3" id="r_a474d79ff81757b0798c498f7e8c9eab3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a474d79ff81757b0798c498f7e8c9eab3">test_memmapping_on_large_enough_dev_shm</a> (factory)</td></tr>
<tr class="separator:a474d79ff81757b0798c498f7e8c9eab3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8b54e6f21b362180760c153fffa97b0b" id="r_a8b54e6f21b362180760c153fffa97b0b"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a8b54e6f21b362180760c153fffa97b0b">test_memmapping_on_too_small_dev_shm</a> (factory)</td></tr>
<tr class="separator:a8b54e6f21b362180760c153fffa97b0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4c21c6e439a1af030e80fb9de68f724" id="r_af4c21c6e439a1af030e80fb9de68f724"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#af4c21c6e439a1af030e80fb9de68f724">test_memmapping_pool_for_large_arrays_in_return</a> (factory, tmpdir)</td></tr>
<tr class="separator:af4c21c6e439a1af030e80fb9de68f724"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a520d06e355032f3c026c54637740c6a3" id="r_a520d06e355032f3c026c54637740c6a3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a520d06e355032f3c026c54637740c6a3">_worker_multiply</a> (<a class="el" href="__blas__subroutines_8h.html#a4da0a64c77789ca4c8115aef76120fd2">a</a>, n_times)</td></tr>
<tr class="separator:a520d06e355032f3c026c54637740c6a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7606e872d878c92b14a9a70faf5ad258" id="r_a7606e872d878c92b14a9a70faf5ad258"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a7606e872d878c92b14a9a70faf5ad258">test_workaround_against_bad_memmap_with_copied_buffers</a> (factory, tmpdir)</td></tr>
<tr class="separator:a7606e872d878c92b14a9a70faf5ad258"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a244578c385616309f77a63d8e4b137e7" id="r_a244578c385616309f77a63d8e4b137e7"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a244578c385616309f77a63d8e4b137e7">identity</a> (arg)</td></tr>
<tr class="separator:a244578c385616309f77a63d8e4b137e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae724fc0a6952d60b2080a82a551f4f17" id="r_ae724fc0a6952d60b2080a82a551f4f17"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#ae724fc0a6952d60b2080a82a551f4f17">test_pool_memmap_with_big_offset</a> (factory, retry_no, tmpdir)</td></tr>
<tr class="separator:ae724fc0a6952d60b2080a82a551f4f17"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad535a3d8b4915968bad70577a1d429f3" id="r_ad535a3d8b4915968bad70577a1d429f3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#ad535a3d8b4915968bad70577a1d429f3">test_pool_get_temp_dir</a> (tmpdir)</td></tr>
<tr class="separator:ad535a3d8b4915968bad70577a1d429f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad788198801245230bc3e5d720f562b5" id="r_aad788198801245230bc3e5d720f562b5"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aad788198801245230bc3e5d720f562b5">test_numpy_arrays_use_different_memory</a> (mmap_mode)</td></tr>
<tr class="separator:aad788198801245230bc3e5d720f562b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3bf63d1d870a91751b4c3ed04dc84ee5" id="r_a3bf63d1d870a91751b4c3ed04dc84ee5"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a3bf63d1d870a91751b4c3ed04dc84ee5">test_weak_array_key_map</a> ()</td></tr>
<tr class="separator:a3bf63d1d870a91751b4c3ed04dc84ee5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a995dfee08b173f64d84af9303cb1b177" id="r_a995dfee08b173f64d84af9303cb1b177"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#a995dfee08b173f64d84af9303cb1b177">test_weak_array_key_map_no_pickling</a> ()</td></tr>
<tr class="separator:a995dfee08b173f64d84af9303cb1b177"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa954b6a1ae137f9aab8e1434ff80b900" id="r_aa954b6a1ae137f9aab8e1434ff80b900"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacejoblib_1_1test_1_1test__memmapping.html#aa954b6a1ae137f9aab8e1434ff80b900">test_direct_mmap</a> (tmpdir)</td></tr>
<tr class="separator:aa954b6a1ae137f9aab8e1434ff80b900"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a520d06e355032f3c026c54637740c6a3" name="a520d06e355032f3c026c54637740c6a3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a520d06e355032f3c026c54637740c6a3">&#9670;&#160;</a></span>_worker_multiply()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping._worker_multiply </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>n_times</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<pre class="fragment">Multiplication function to be executed by subprocess</pre> <div class="fragment"><div class="line"><span class="lineno">  983</span><span class="keyword">def </span>_worker_multiply(a, n_times):</div>
<div class="line"><span class="lineno">  984</span>    <span class="stringliteral">&quot;&quot;&quot;Multiplication function to be executed by subprocess&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  985</span>    <span class="keyword">assert</span> has_shareable_memory(a)</div>
<div class="line"><span class="lineno">  986</span>    <span class="keywordflow">return</span> a * n_times</div>
<div class="line"><span class="lineno">  987</span> </div>
<div class="line"><span class="lineno">  988</span> </div>
<div class="line"><span class="lineno">  989</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  990</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  991</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  992</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="a276dc8cd54c8a2295ef5c4e645ae5266" name="a276dc8cd54c8a2295ef5c4e645ae5266"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a276dc8cd54c8a2295ef5c4e645ae5266">&#9670;&#160;</a></span>check_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.check_array </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Dummy helper function to be executed in subprocesses

Check that the provided array has the expected values in the provided
range.</pre> <div class="fragment"><div class="line"><span class="lineno">   47</span><span class="keyword">def </span>check_array(args):</div>
<div class="line"><span class="lineno">   48</span>    <span class="stringliteral">&quot;&quot;&quot;Dummy helper function to be executed in subprocesses</span></div>
<div class="line"><span class="lineno">   49</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   50</span><span class="stringliteral">    Check that the provided array has the expected values in the provided</span></div>
<div class="line"><span class="lineno">   51</span><span class="stringliteral">    range.</span></div>
<div class="line"><span class="lineno">   52</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   53</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   54</span>    data, position, expected = args</div>
<div class="line"><span class="lineno">   55</span>    np.testing.assert_array_equal(data[position], expected)</div>
<div class="line"><span class="lineno">   56</span> </div>
<div class="line"><span class="lineno">   57</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a12f9323317a15713d6a9db70e19562bb" name="a12f9323317a15713d6a9db70e19562bb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a12f9323317a15713d6a9db70e19562bb">&#9670;&#160;</a></span>check_memmap_and_send_back()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.check_memmap_and_send_back </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>array</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   42</span><span class="keyword">def </span>check_memmap_and_send_back(array):</div>
<div class="line"><span class="lineno">   43</span>    <span class="keyword">assert</span> _get_backing_memmap(array) <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">   44</span>    <span class="keywordflow">return</span> array</div>
<div class="line"><span class="lineno">   45</span> </div>
<div class="line"><span class="lineno">   46</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a244578c385616309f77a63d8e4b137e7" name="a244578c385616309f77a63d8e4b137e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a244578c385616309f77a63d8e4b137e7">&#9670;&#160;</a></span>identity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.identity </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>arg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1018</span><span class="keyword">def </span>identity(arg):</div>
<div class="line"><span class="lineno"> 1019</span>    <span class="keywordflow">return</span> arg</div>
<div class="line"><span class="lineno"> 1020</span> </div>
<div class="line"><span class="lineno"> 1021</span> </div>
<div class="line"><span class="lineno"> 1022</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno"> 1023</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno"> 1024</span><span class="preprocessor">@parametrize</span>(</div>
<div class="line"><span class="lineno"> 1025</span>    <span class="stringliteral">&quot;factory,retry_no&quot;</span>,</div>
<div class="line"><span class="lineno"> 1026</span>    list(itertools.product(</div>
<div class="line"><span class="lineno"> 1027</span>        [MemmappingPool, TestExecutor.get_memmapping_executor], range(3))),</div>
<div class="line"><span class="lineno"> 1028</span>    ids=[<span class="stringliteral">&#39;{}, {}&#39;</span>.format(x, y) <span class="keywordflow">for</span> x, y <span class="keywordflow">in</span> itertools.product(</div>
<div class="line"><span class="lineno"> 1029</span>        [<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>], map(str, range(3)))])</div>
</div><!-- fragment -->
</div>
</div>
<a id="ab06b583152ef75629a785832b74544a0" name="ab06b583152ef75629a785832b74544a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab06b583152ef75629a785832b74544a0">&#9670;&#160;</a></span>inplace_double()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.inplace_double </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Dummy helper function to be executed in subprocesses


Check that the input array has the right values in the provided range
and perform an inplace modification to double the values in the range by
two.</pre> <div class="fragment"><div class="line"><span class="lineno">   58</span><span class="keyword">def </span>inplace_double(args):</div>
<div class="line"><span class="lineno">   59</span>    <span class="stringliteral">&quot;&quot;&quot;Dummy helper function to be executed in subprocesses</span></div>
<div class="line"><span class="lineno">   60</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   61</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   62</span><span class="stringliteral">    Check that the input array has the right values in the provided range</span></div>
<div class="line"><span class="lineno">   63</span><span class="stringliteral">    and perform an inplace modification to double the values in the range by</span></div>
<div class="line"><span class="lineno">   64</span><span class="stringliteral">    two.</span></div>
<div class="line"><span class="lineno">   65</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   66</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   67</span>    data, position, expected = args</div>
<div class="line"><span class="lineno">   68</span>    <span class="keyword">assert</span> data[position] == expected</div>
<div class="line"><span class="lineno">   69</span>    data[position] *= 2</div>
<div class="line"><span class="lineno">   70</span>    np.testing.assert_array_equal(data[position], 2 * expected)</div>
<div class="line"><span class="lineno">   71</span> </div>
<div class="line"><span class="lineno">   72</span> </div>
<div class="line"><span class="lineno">   73</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">   74</span><span class="preprocessor">@with_multiprocessing</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="aa9a776b36f43359e16e59ee5e35c2bea" name="aa9a776b36f43359e16e59ee5e35c2bea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa9a776b36f43359e16e59ee5e35c2bea">&#9670;&#160;</a></span>setup_module()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.setup_module </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   34</span><span class="keyword">def </span>setup_module():</div>
<div class="line"><span class="lineno">   35</span>    setup_autokill(__name__, timeout=300)</div>
<div class="line"><span class="lineno">   36</span> </div>
<div class="line"><span class="lineno">   37</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="abf0ecd54bd0ffb627700935108783d6a" name="abf0ecd54bd0ffb627700935108783d6a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf0ecd54bd0ffb627700935108783d6a">&#9670;&#160;</a></span>teardown_module()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.teardown_module </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   38</span><span class="keyword">def </span>teardown_module():</div>
<div class="line"><span class="lineno">   39</span>    teardown_autokill(__name__)</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a07dd9c9d27a91406c20c2ac6939df7ec" name="a07dd9c9d27a91406c20c2ac6939df7ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a07dd9c9d27a91406c20c2ac6939df7ec">&#9670;&#160;</a></span>test__strided_from_memmap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test__strided_from_memmap </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  246</span><span class="keyword">def </span>test__strided_from_memmap(tmpdir):</div>
<div class="line"><span class="lineno">  247</span>    fname = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  248</span>    size = 5 * mmap.ALLOCATIONGRANULARITY</div>
<div class="line"><span class="lineno">  249</span>    offset = mmap.ALLOCATIONGRANULARITY + 1</div>
<div class="line"><span class="lineno">  250</span>    <span class="comment"># This line creates the mmap file that is reused later</span></div>
<div class="line"><span class="lineno">  251</span>    memmap_obj = np.memmap(fname, mode=<span class="stringliteral">&#39;w+&#39;</span>, shape=size + offset)</div>
<div class="line"><span class="lineno">  252</span>    <span class="comment"># filename, dtype, mode, offset, order, shape, strides, total_buffer_len</span></div>
<div class="line"><span class="lineno">  253</span>    memmap_obj = _strided_from_memmap(fname, dtype=<span class="stringliteral">&#39;uint8&#39;</span>, mode=<span class="stringliteral">&#39;r&#39;</span>,</div>
<div class="line"><span class="lineno">  254</span>                                      offset=offset, order=<span class="stringliteral">&#39;C&#39;</span>, shape=size,</div>
<div class="line"><span class="lineno">  255</span>                                      strides=<span class="keywordtype">None</span>, total_buffer_len=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  256</span>                                      unlink_on_gc_collect=<span class="keyword">False</span>)</div>
<div class="line"><span class="lineno">  257</span>    <span class="keyword">assert</span> isinstance(memmap_obj, np.memmap)</div>
<div class="line"><span class="lineno">  258</span>    <span class="keyword">assert</span> memmap_obj.offset == offset</div>
<div class="line"><span class="lineno">  259</span>    memmap_backed_obj = _strided_from_memmap(</div>
<div class="line"><span class="lineno">  260</span>        fname, dtype=<span class="stringliteral">&#39;uint8&#39;</span>, mode=<span class="stringliteral">&#39;r&#39;</span>, offset=offset, order=<span class="stringliteral">&#39;C&#39;</span>,</div>
<div class="line"><span class="lineno">  261</span>        shape=(size // 2,), strides=(2,), total_buffer_len=size,</div>
<div class="line"><span class="lineno">  262</span>        unlink_on_gc_collect=<span class="keyword">False</span></div>
<div class="line"><span class="lineno">  263</span>    )</div>
<div class="line"><span class="lineno">  264</span>    <span class="keyword">assert</span> _get_backing_memmap(memmap_backed_obj).offset == offset</div>
<div class="line"><span class="lineno">  265</span> </div>
<div class="line"><span class="lineno">  266</span> </div>
<div class="line"><span class="lineno">  267</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  268</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  269</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  270</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa0cceace3e40184df8cdd07519f33812" name="aa0cceace3e40184df8cdd07519f33812"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa0cceace3e40184df8cdd07519f33812">&#9670;&#160;</a></span>test_child_raises_parent_exits_cleanly()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_child_raises_parent_exits_cleanly </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  773</span><span class="keyword">def </span>test_child_raises_parent_exits_cleanly(backend):</div>
<div class="line"><span class="lineno">  774</span>    <span class="comment"># When a task executed by a child process raises an error, the parent</span></div>
<div class="line"><span class="lineno">  775</span>    <span class="comment"># process&#39;s backend is notified, and calls abort_everything.</span></div>
<div class="line"><span class="lineno">  776</span>    <span class="comment"># In loky, abort_everything itself calls shutdown(kill_workers=True) which</span></div>
<div class="line"><span class="lineno">  777</span>    <span class="comment"># sends SIGKILL to the worker, preventing it from running the finalizers</span></div>
<div class="line"><span class="lineno">  778</span>    <span class="comment"># supposed to signal the resource_tracker when the worker is done using</span></div>
<div class="line"><span class="lineno">  779</span>    <span class="comment"># objects relying on a shared resource (e.g np.memmaps). Because this</span></div>
<div class="line"><span class="lineno">  780</span>    <span class="comment"># behavior is prone to :</span></div>
<div class="line"><span class="lineno">  781</span>    <span class="comment"># - cause a resource leak</span></div>
<div class="line"><span class="lineno">  782</span>    <span class="comment"># - make the resource tracker emit noisy resource warnings</span></div>
<div class="line"><span class="lineno">  783</span>    <span class="comment"># we explicitly test that, when the said situation occurs:</span></div>
<div class="line"><span class="lineno">  784</span>    <span class="comment"># - no resources are actually leaked</span></div>
<div class="line"><span class="lineno">  785</span>    <span class="comment"># - the temporary resources are deleted as soon as possible (typically, at</span></div>
<div class="line"><span class="lineno">  786</span>    <span class="comment">#   the end of the failing Parallel call)</span></div>
<div class="line"><span class="lineno">  787</span>    <span class="comment"># - the resource_tracker does not emit any warnings.</span></div>
<div class="line"><span class="lineno">  788</span>    cmd = <span class="stringliteral">&quot;&quot;&quot;if 1:</span></div>
<div class="line"><span class="lineno">  789</span><span class="stringliteral">        import os</span></div>
<div class="line"><span class="lineno">  790</span><span class="stringliteral">        from pathlib import Path</span></div>
<div class="line"><span class="lineno">  791</span><span class="stringliteral">        from time import sleep</span></div>
<div class="line"><span class="lineno">  792</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  793</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  794</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  795</span><span class="stringliteral">        from testutils import print_filename_and_raise</span></div>
<div class="line"><span class="lineno">  796</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  797</span><span class="stringliteral">        data = np.random.rand(1000)</span></div>
<div class="line"><span class="lineno">  798</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  799</span><span class="stringliteral">        def get_temp_folder(parallel_obj, backend):</span></div>
<div class="line"><span class="lineno">  800</span><span class="stringliteral">            if &quot;{b}&quot; == &quot;loky&quot;:</span></div>
<div class="line"><span class="lineno">  801</span><span class="stringliteral">                return Path(p._backend._workers._temp_folder)</span></div>
<div class="line"><span class="lineno">  802</span><span class="stringliteral">            else:</span></div>
<div class="line"><span class="lineno">  803</span><span class="stringliteral">                return Path(p._backend._pool._temp_folder)</span></div>
<div class="line"><span class="lineno">  804</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  805</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  806</span><span class="stringliteral">        if __name__ == &quot;__main__&quot;:</span></div>
<div class="line"><span class="lineno">  807</span><span class="stringliteral">            try:</span></div>
<div class="line"><span class="lineno">  808</span><span class="stringliteral">                with Parallel(n_jobs=2, backend=&quot;{b}&quot;, max_nbytes=100) as p:</span></div>
<div class="line"><span class="lineno">  809</span><span class="stringliteral">                    temp_folder = get_temp_folder(p, &quot;{b}&quot;)</span></div>
<div class="line"><span class="lineno">  810</span><span class="stringliteral">                    p(delayed(print_filename_and_raise)(data)</span></div>
<div class="line"><span class="lineno">  811</span><span class="stringliteral">                              for i in range(1))</span></div>
<div class="line"><span class="lineno">  812</span><span class="stringliteral">            except ValueError as e:</span></div>
<div class="line"><span class="lineno">  813</span><span class="stringliteral">                # the temporary folder should be deleted by the end of this</span></div>
<div class="line"><span class="lineno">  814</span><span class="stringliteral">                # call but apparently on some file systems, this takes</span></div>
<div class="line"><span class="lineno">  815</span><span class="stringliteral">                # some time to be visible.</span></div>
<div class="line"><span class="lineno">  816</span><span class="stringliteral">                #</span></div>
<div class="line"><span class="lineno">  817</span><span class="stringliteral">                # We attempt to write into the temporary folder to test for</span></div>
<div class="line"><span class="lineno">  818</span><span class="stringliteral">                # its existence and we wait for a maximum of 10 seconds.</span></div>
<div class="line"><span class="lineno">  819</span><span class="stringliteral">                for i in range(100):</span></div>
<div class="line"><span class="lineno">  820</span><span class="stringliteral">                    try:</span></div>
<div class="line"><span class="lineno">  821</span><span class="stringliteral">                        with open(temp_folder / &quot;some_file.txt&quot;, &quot;w&quot;) as f:</span></div>
<div class="line"><span class="lineno">  822</span><span class="stringliteral">                            f.write(&quot;some content&quot;)</span></div>
<div class="line"><span class="lineno">  823</span><span class="stringliteral">                    except FileNotFoundError:</span></div>
<div class="line"><span class="lineno">  824</span><span class="stringliteral">                        # temp_folder has been deleted, all is fine</span></div>
<div class="line"><span class="lineno">  825</span><span class="stringliteral">                        break</span></div>
<div class="line"><span class="lineno">  826</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  827</span><span class="stringliteral">                    # ... else, wait a bit and try again</span></div>
<div class="line"><span class="lineno">  828</span><span class="stringliteral">                    sleep(.1)</span></div>
<div class="line"><span class="lineno">  829</span><span class="stringliteral">                else:</span></div>
<div class="line"><span class="lineno">  830</span><span class="stringliteral">                    raise AssertionError(</span></div>
<div class="line"><span class="lineno">  831</span><span class="stringliteral">                        str(temp_folder) + &quot; was not deleted&quot;</span></div>
<div class="line"><span class="lineno">  832</span><span class="stringliteral">                    ) from e</span></div>
<div class="line"><span class="lineno">  833</span><span class="stringliteral">    &quot;&quot;&quot;</span>.format(b=backend)</div>
<div class="line"><span class="lineno">  834</span>    env = os.environ.copy()</div>
<div class="line"><span class="lineno">  835</span>    env[<span class="stringliteral">&#39;PYTHONPATH&#39;</span>] = os.path.dirname(__file__)</div>
<div class="line"><span class="lineno">  836</span>    p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd], stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  837</span>                         stdout=subprocess.PIPE, env=env)</div>
<div class="line"><span class="lineno">  838</span>    p.wait()</div>
<div class="line"><span class="lineno">  839</span>    out, err = p.communicate()</div>
<div class="line"><span class="lineno">  840</span>    out, err = out.decode(), err.decode()</div>
<div class="line"><span class="lineno">  841</span>    filename = out.split(<span class="stringliteral">&#39;\n&#39;</span>)[0]</div>
<div class="line"><span class="lineno">  842</span>    <span class="keyword">assert</span> p.returncode == 0, err <span class="keywordflow">or</span> out</div>
<div class="line"><span class="lineno">  843</span>    <span class="keyword">assert</span> err == <span class="stringliteral">&#39;&#39;</span>  <span class="comment"># no resource_tracker warnings.</span></div>
<div class="line"><span class="lineno">  844</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> os.path.exists(filename)</div>
<div class="line"><span class="lineno">  845</span> </div>
<div class="line"><span class="lineno">  846</span> </div>
<div class="line"><span class="lineno">  847</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  848</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  849</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  850</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa954b6a1ae137f9aab8e1434ff80b900" name="aa954b6a1ae137f9aab8e1434ff80b900"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa954b6a1ae137f9aab8e1434ff80b900">&#9670;&#160;</a></span>test_direct_mmap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_direct_mmap </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1146</span><span class="keyword">def </span>test_direct_mmap(tmpdir):</div>
<div class="line"><span class="lineno"> 1147</span>    testfile = str(tmpdir.join(<span class="stringliteral">&#39;arr.dat&#39;</span>))</div>
<div class="line"><span class="lineno"> 1148</span>    a = np.arange(10, dtype=<span class="stringliteral">&#39;uint8&#39;</span>)</div>
<div class="line"><span class="lineno"> 1149</span>    a.tofile(testfile)</div>
<div class="line"><span class="lineno"> 1150</span> </div>
<div class="line"><span class="lineno"> 1151</span>    <span class="keyword">def </span>_read_array():</div>
<div class="line"><span class="lineno"> 1152</span>        <span class="keyword">with</span> open(testfile) <span class="keyword">as</span> fd:</div>
<div class="line"><span class="lineno"> 1153</span>            mm = mmap.mmap(fd.fileno(), 0, access=mmap.ACCESS_READ, offset=0)</div>
<div class="line"><span class="lineno"> 1154</span>        <span class="keywordflow">return</span> np.ndarray((10,), dtype=np.uint8, buffer=mm, offset=0)</div>
<div class="line"><span class="lineno"> 1155</span> </div>
<div class="line"><span class="lineno"> 1156</span>    <span class="keyword">def </span><a class="code hl_function" href="callback_2foo_8f.html#a565fe2cc583df102f120752b0011c330">func</a>(x):</div>
<div class="line"><span class="lineno"> 1157</span>        <span class="keywordflow">return</span> x**2</div>
<div class="line"><span class="lineno"> 1158</span> </div>
<div class="line"><span class="lineno"> 1159</span>    arr = _read_array()</div>
<div class="line"><span class="lineno"> 1160</span> </div>
<div class="line"><span class="lineno"> 1161</span>    <span class="comment"># this is expected to work and gives the reference</span></div>
<div class="line"><span class="lineno"> 1162</span>    ref = Parallel(n_jobs=2)(delayed(func)(x) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> [a])</div>
<div class="line"><span class="lineno"> 1163</span> </div>
<div class="line"><span class="lineno"> 1164</span>    <span class="comment"># now test that it work with the mmap array</span></div>
<div class="line"><span class="lineno"> 1165</span>    results = Parallel(n_jobs=2)(delayed(func)(x) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> [arr])</div>
<div class="line"><span class="lineno"> 1166</span>    np.testing.assert_array_equal(results, ref)</div>
<div class="line"><span class="lineno"> 1167</span> </div>
<div class="line"><span class="lineno"> 1168</span>    <span class="comment"># also test with a mmap array read in the subprocess</span></div>
<div class="line"><span class="lineno"> 1169</span>    <span class="keyword">def </span>worker():</div>
<div class="line"><span class="lineno"> 1170</span>        <span class="keywordflow">return</span> _read_array()</div>
<div class="line"><span class="lineno"> 1171</span> </div>
<div class="line"><span class="lineno"> 1172</span>    results = Parallel(n_jobs=2)(delayed(worker)() <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1))</div>
<div class="line"><span class="lineno"> 1173</span>    np.testing.assert_array_equal(results[0], arr)</div>
<div class="ttc" id="acallback_2foo_8f_html_a565fe2cc583df102f120752b0011c330"><div class="ttname"><a href="callback_2foo_8f.html#a565fe2cc583df102f120752b0011c330">func</a></div><div class="ttdeci">subroutine func(a)</div><div class="ttdef"><b>Definition</b> foo.f:9</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a358edab92a5e6568713b69acc9fa02a9" name="a358edab92a5e6568713b69acc9fa02a9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a358edab92a5e6568713b69acc9fa02a9">&#9670;&#160;</a></span>test_high_dimension_memmap_array_reducing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_high_dimension_memmap_array_reducing </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  200</span><span class="keyword">def </span>test_high_dimension_memmap_array_reducing(tmpdir):</div>
<div class="line"><span class="lineno">  201</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno">  202</span> </div>
<div class="line"><span class="lineno">  203</span>    filename = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>    <span class="comment"># Create a high dimensional memmap</span></div>
<div class="line"><span class="lineno">  206</span>    a = np.memmap(filename, dtype=np.float64, shape=(100, 15, 15, 3),</div>
<div class="line"><span class="lineno">  207</span>                  mode=<span class="stringliteral">&#39;w+&#39;</span>)</div>
<div class="line"><span class="lineno">  208</span>    a[:] = np.arange(100 * 15 * 15 * 3).reshape(a.shape)</div>
<div class="line"><span class="lineno">  209</span> </div>
<div class="line"><span class="lineno">  210</span>    <span class="comment"># Create some slices/indices at various dimensions</span></div>
<div class="line"><span class="lineno">  211</span>    b = a[0:10]</div>
<div class="line"><span class="lineno">  212</span>    c = a[:, 5:10]</div>
<div class="line"><span class="lineno">  213</span>    d = a[:, :, :, 0]</div>
<div class="line"><span class="lineno">  214</span>    e = a[1:3:4]</div>
<div class="line"><span class="lineno">  215</span> </div>
<div class="line"><span class="lineno">  216</span>    <span class="comment"># Array reducer with auto dumping disabled</span></div>
<div class="line"><span class="lineno">  217</span>    reducer = ArrayMemmapForwardReducer(<span class="keywordtype">None</span>, tmpdir.strpath, <span class="stringliteral">&#39;c&#39;</span>, <span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  218</span> </div>
<div class="line"><span class="lineno">  219</span>    <span class="keyword">def </span>reconstruct_array_or_memmap(x):</div>
<div class="line"><span class="lineno">  220</span>        cons, args = reducer(x)</div>
<div class="line"><span class="lineno">  221</span>        <span class="keywordflow">return</span> cons(*args)</div>
<div class="line"><span class="lineno">  222</span> </div>
<div class="line"><span class="lineno">  223</span>    a_reconstructed = reconstruct_array_or_memmap(a)</div>
<div class="line"><span class="lineno">  224</span>    <span class="keyword">assert</span> has_shareable_memory(a_reconstructed)</div>
<div class="line"><span class="lineno">  225</span>    <span class="keyword">assert</span> isinstance(a_reconstructed, np.memmap)</div>
<div class="line"><span class="lineno">  226</span>    assert_array_equal(a_reconstructed, a)</div>
<div class="line"><span class="lineno">  227</span> </div>
<div class="line"><span class="lineno">  228</span>    b_reconstructed = reconstruct_array_or_memmap(b)</div>
<div class="line"><span class="lineno">  229</span>    <span class="keyword">assert</span> has_shareable_memory(b_reconstructed)</div>
<div class="line"><span class="lineno">  230</span>    assert_array_equal(b_reconstructed, b)</div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>    c_reconstructed = reconstruct_array_or_memmap(c)</div>
<div class="line"><span class="lineno">  233</span>    <span class="keyword">assert</span> has_shareable_memory(c_reconstructed)</div>
<div class="line"><span class="lineno">  234</span>    assert_array_equal(c_reconstructed, c)</div>
<div class="line"><span class="lineno">  235</span> </div>
<div class="line"><span class="lineno">  236</span>    d_reconstructed = reconstruct_array_or_memmap(d)</div>
<div class="line"><span class="lineno">  237</span>    <span class="keyword">assert</span> has_shareable_memory(d_reconstructed)</div>
<div class="line"><span class="lineno">  238</span>    assert_array_equal(d_reconstructed, d)</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>    e_reconstructed = reconstruct_array_or_memmap(e)</div>
<div class="line"><span class="lineno">  241</span>    <span class="keyword">assert</span> has_shareable_memory(e_reconstructed)</div>
<div class="line"><span class="lineno">  242</span>    assert_array_equal(e_reconstructed, e)</div>
<div class="line"><span class="lineno">  243</span> </div>
<div class="line"><span class="lineno">  244</span> </div>
<div class="line"><span class="lineno">  245</span><span class="preprocessor">@with_numpy</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a68e41ef783161ffc54f4234929af7500" name="a68e41ef783161ffc54f4234929af7500"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68e41ef783161ffc54f4234929af7500">&#9670;&#160;</a></span>test_managed_backend_reuse_temp_folder()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_managed_backend_reuse_temp_folder </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  464</span><span class="keyword">def </span>test_managed_backend_reuse_temp_folder(backend):</div>
<div class="line"><span class="lineno">  465</span>    <span class="comment"># Test that calls to a managed parallel object reuse the same memmaps.</span></div>
<div class="line"><span class="lineno">  466</span>    array = np.arange(int(1e2))</div>
<div class="line"><span class="lineno">  467</span>    <span class="keyword">with</span> Parallel(n_jobs=2, backend=backend, max_nbytes=10) <span class="keyword">as</span> p:</div>
<div class="line"><span class="lineno">  468</span>        [filename_1] = p(</div>
<div class="line"><span class="lineno">  469</span>            delayed(getattr)(array, <span class="stringliteral">&#39;filename&#39;</span>) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1)</div>
<div class="line"><span class="lineno">  470</span>        )</div>
<div class="line"><span class="lineno">  471</span>        [filename_2] = p(</div>
<div class="line"><span class="lineno">  472</span>            delayed(getattr)(array, <span class="stringliteral">&#39;filename&#39;</span>) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1)</div>
<div class="line"><span class="lineno">  473</span>        )</div>
<div class="line"><span class="lineno">  474</span>    <span class="keyword">assert</span> os.path.dirname(filename_2) == os.path.dirname(filename_1)</div>
<div class="line"><span class="lineno">  475</span> </div>
<div class="line"><span class="lineno">  476</span> </div>
<div class="line"><span class="lineno">  477</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  478</span><span class="preprocessor">@with_multiprocessing</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a7e84761c2c738996901e20737cbf9c69" name="a7e84761c2c738996901e20737cbf9c69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7e84761c2c738996901e20737cbf9c69">&#9670;&#160;</a></span>test_many_parallel_calls_on_same_object()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_many_parallel_calls_on_same_object </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  592</span><span class="keyword">def </span>test_many_parallel_calls_on_same_object(backend):</div>
<div class="line"><span class="lineno">  593</span>    <span class="comment"># After #966 got merged, consecutive Parallel objects were sharing temp</span></div>
<div class="line"><span class="lineno">  594</span>    <span class="comment"># folder, which would lead to race conditions happening during the</span></div>
<div class="line"><span class="lineno">  595</span>    <span class="comment"># temporary resources management with the resource_tracker. This is a</span></div>
<div class="line"><span class="lineno">  596</span>    <span class="comment"># non-regression test that makes sure that consecutive Parallel operations</span></div>
<div class="line"><span class="lineno">  597</span>    <span class="comment"># on the same object do not error out.</span></div>
<div class="line"><span class="lineno">  598</span>    cmd = <span class="stringliteral">&#39;&#39;&#39;if 1:</span></div>
<div class="line"><span class="lineno">  599</span><span class="stringliteral">        import os</span></div>
<div class="line"><span class="lineno">  600</span><span class="stringliteral">        import time</span></div>
<div class="line"><span class="lineno">  601</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  602</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  603</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  604</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  605</span><span class="stringliteral">        from testutils import return_slice_of_data</span></div>
<div class="line"><span class="lineno">  606</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  607</span><span class="stringliteral">        data = np.ones(100)</span></div>
<div class="line"><span class="lineno">  608</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  609</span><span class="stringliteral">        if __name__ == &#39;__main__&#39;:</span></div>
<div class="line"><span class="lineno">  610</span><span class="stringliteral">            for i in range(5):</span></div>
<div class="line"><span class="lineno">  611</span><span class="stringliteral">                slice_of_data = Parallel(</span></div>
<div class="line"><span class="lineno">  612</span><span class="stringliteral">                    n_jobs=2, max_nbytes=1, backend=&#39;{b}&#39;)(</span></div>
<div class="line"><span class="lineno">  613</span><span class="stringliteral">                        delayed(return_slice_of_data)(data, 0, 20)</span></div>
<div class="line"><span class="lineno">  614</span><span class="stringliteral">                        for _ in range(10)</span></div>
<div class="line"><span class="lineno">  615</span><span class="stringliteral">                    )</span></div>
<div class="line"><span class="lineno">  616</span><span class="stringliteral">    &#39;&#39;&#39;</span>.format(b=backend)</div>
<div class="line"><span class="lineno">  617</span>    env = os.environ.copy()</div>
<div class="line"><span class="lineno">  618</span>    env[<span class="stringliteral">&#39;PYTHONPATH&#39;</span>] = os.path.dirname(__file__)</div>
<div class="line"><span class="lineno">  619</span>    p = subprocess.Popen(</div>
<div class="line"><span class="lineno">  620</span>        [sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd],</div>
<div class="line"><span class="lineno">  621</span>        stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  622</span>        stdout=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  623</span>        env=env,</div>
<div class="line"><span class="lineno">  624</span>    )</div>
<div class="line"><span class="lineno">  625</span>    p.wait()</div>
<div class="line"><span class="lineno">  626</span>    out, err = p.communicate()</div>
<div class="line"><span class="lineno">  627</span>    <span class="keyword">assert</span> p.returncode == 0, err</div>
<div class="line"><span class="lineno">  628</span>    <span class="keyword">assert</span> out == b<span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><span class="lineno">  629</span>    <span class="keywordflow">if</span> sys.version_info[:3] <span class="keywordflow">not</span> <span class="keywordflow">in</span> [(3, 8, 0), (3, 8, 1)]:</div>
<div class="line"><span class="lineno">  630</span>        <span class="comment"># In early versions of Python 3.8, a reference leak</span></div>
<div class="line"><span class="lineno">  631</span>        <span class="comment"># https://github.com/cloudpipe/cloudpickle/issues/327, holds</span></div>
<div class="line"><span class="lineno">  632</span>        <span class="comment"># references to pickled objects, generating race condition during</span></div>
<div class="line"><span class="lineno">  633</span>        <span class="comment"># cleanup finalizers of joblib and noisy resource_tracker outputs.</span></div>
<div class="line"><span class="lineno">  634</span>        <span class="keyword">assert</span> b<span class="stringliteral">&#39;resource_tracker&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> err</div>
<div class="line"><span class="lineno">  635</span> </div>
<div class="line"><span class="lineno">  636</span> </div>
<div class="line"><span class="lineno">  637</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  638</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  639</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a782913b56aaee94e0b03429d0d6c3c98" name="a782913b56aaee94e0b03429d0d6c3c98"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a782913b56aaee94e0b03429d0d6c3c98">&#9670;&#160;</a></span>test_memmap_based_array_reducing()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmap_based_array_reducing </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that it is possible to reduce a memmap backed array</pre> <div class="fragment"><div class="line"><span class="lineno">   75</span><span class="keyword">def </span>test_memmap_based_array_reducing(tmpdir):</div>
<div class="line"><span class="lineno">   76</span>    <span class="stringliteral">&quot;&quot;&quot;Check that it is possible to reduce a memmap backed array&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   77</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno">   78</span>    filename = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">   79</span> </div>
<div class="line"><span class="lineno">   80</span>    <span class="comment"># Create a file larger than what will be used by a</span></div>
<div class="line"><span class="lineno">   81</span>    buffer = np.memmap(filename, dtype=np.float64, shape=500, mode=<span class="stringliteral">&#39;w+&#39;</span>)</div>
<div class="line"><span class="lineno">   82</span> </div>
<div class="line"><span class="lineno">   83</span>    <span class="comment"># Fill the original buffer with negative markers to detect over of</span></div>
<div class="line"><span class="lineno">   84</span>    <span class="comment"># underflow in case of test failures</span></div>
<div class="line"><span class="lineno">   85</span>    buffer[:] = - 1.0 * np.arange(buffer.shape[0], dtype=buffer.dtype)</div>
<div class="line"><span class="lineno">   86</span>    buffer.flush()</div>
<div class="line"><span class="lineno">   87</span> </div>
<div class="line"><span class="lineno">   88</span>    <span class="comment"># Memmap a 2D fortran array on a offsetted subsection of the previous</span></div>
<div class="line"><span class="lineno">   89</span>    <span class="comment"># buffer</span></div>
<div class="line"><span class="lineno">   90</span>    a = np.memmap(filename, dtype=np.float64, shape=(3, 5, 4),</div>
<div class="line"><span class="lineno">   91</span>                  mode=<span class="stringliteral">&#39;r+&#39;</span>, order=<span class="stringliteral">&#39;F&#39;</span>, offset=4)</div>
<div class="line"><span class="lineno">   92</span>    a[:] = np.arange(60).reshape(a.shape)</div>
<div class="line"><span class="lineno">   93</span> </div>
<div class="line"><span class="lineno">   94</span>    <span class="comment"># Build various views that share the buffer with the original memmap</span></div>
<div class="line"><span class="lineno">   95</span> </div>
<div class="line"><span class="lineno">   96</span>    <span class="comment"># b is an memmap sliced view on an memmap instance</span></div>
<div class="line"><span class="lineno">   97</span>    b = a[1:-1, 2:-1, 2:4]</div>
<div class="line"><span class="lineno">   98</span> </div>
<div class="line"><span class="lineno">   99</span>    <span class="comment"># c and d are array views</span></div>
<div class="line"><span class="lineno">  100</span>    c = np.asarray(b)</div>
<div class="line"><span class="lineno">  101</span>    d = c.T</div>
<div class="line"><span class="lineno">  102</span> </div>
<div class="line"><span class="lineno">  103</span>    <span class="comment"># Array reducer with auto dumping disabled</span></div>
<div class="line"><span class="lineno">  104</span>    reducer = ArrayMemmapForwardReducer(<span class="keywordtype">None</span>, tmpdir.strpath, <span class="stringliteral">&#39;c&#39;</span>, <span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  105</span> </div>
<div class="line"><span class="lineno">  106</span>    <span class="keyword">def </span>reconstruct_array_or_memmap(x):</div>
<div class="line"><span class="lineno">  107</span>        cons, args = reducer(x)</div>
<div class="line"><span class="lineno">  108</span>        <span class="keywordflow">return</span> cons(*args)</div>
<div class="line"><span class="lineno">  109</span> </div>
<div class="line"><span class="lineno">  110</span>    <span class="comment"># Reconstruct original memmap</span></div>
<div class="line"><span class="lineno">  111</span>    a_reconstructed = reconstruct_array_or_memmap(a)</div>
<div class="line"><span class="lineno">  112</span>    <span class="keyword">assert</span> has_shareable_memory(a_reconstructed)</div>
<div class="line"><span class="lineno">  113</span>    <span class="keyword">assert</span> isinstance(a_reconstructed, np.memmap)</div>
<div class="line"><span class="lineno">  114</span>    assert_array_equal(a_reconstructed, a)</div>
<div class="line"><span class="lineno">  115</span> </div>
<div class="line"><span class="lineno">  116</span>    <span class="comment"># Reconstruct strided memmap view</span></div>
<div class="line"><span class="lineno">  117</span>    b_reconstructed = reconstruct_array_or_memmap(b)</div>
<div class="line"><span class="lineno">  118</span>    <span class="keyword">assert</span> has_shareable_memory(b_reconstructed)</div>
<div class="line"><span class="lineno">  119</span>    assert_array_equal(b_reconstructed, b)</div>
<div class="line"><span class="lineno">  120</span> </div>
<div class="line"><span class="lineno">  121</span>    <span class="comment"># Reconstruct arrays views on memmap base</span></div>
<div class="line"><span class="lineno">  122</span>    c_reconstructed = reconstruct_array_or_memmap(c)</div>
<div class="line"><span class="lineno">  123</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> isinstance(c_reconstructed, np.memmap)</div>
<div class="line"><span class="lineno">  124</span>    <span class="keyword">assert</span> has_shareable_memory(c_reconstructed)</div>
<div class="line"><span class="lineno">  125</span>    assert_array_equal(c_reconstructed, c)</div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span>    d_reconstructed = reconstruct_array_or_memmap(d)</div>
<div class="line"><span class="lineno">  128</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> isinstance(d_reconstructed, np.memmap)</div>
<div class="line"><span class="lineno">  129</span>    <span class="keyword">assert</span> has_shareable_memory(d_reconstructed)</div>
<div class="line"><span class="lineno">  130</span>    assert_array_equal(d_reconstructed, d)</div>
<div class="line"><span class="lineno">  131</span> </div>
<div class="line"><span class="lineno">  132</span>    <span class="comment"># Test graceful degradation on fake memmap instances with in-memory</span></div>
<div class="line"><span class="lineno">  133</span>    <span class="comment"># buffers</span></div>
<div class="line"><span class="lineno">  134</span>    a3 = a * 3</div>
<div class="line"><span class="lineno">  135</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(a3)</div>
<div class="line"><span class="lineno">  136</span>    a3_reconstructed = reconstruct_array_or_memmap(a3)</div>
<div class="line"><span class="lineno">  137</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(a3_reconstructed)</div>
<div class="line"><span class="lineno">  138</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> isinstance(a3_reconstructed, np.memmap)</div>
<div class="line"><span class="lineno">  139</span>    assert_array_equal(a3_reconstructed, a * 3)</div>
<div class="line"><span class="lineno">  140</span> </div>
<div class="line"><span class="lineno">  141</span>    <span class="comment"># Test graceful degradation on arrays derived from fake memmap instances</span></div>
<div class="line"><span class="lineno">  142</span>    b3 = np.asarray(a3)</div>
<div class="line"><span class="lineno">  143</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(b3)</div>
<div class="line"><span class="lineno">  144</span> </div>
<div class="line"><span class="lineno">  145</span>    b3_reconstructed = reconstruct_array_or_memmap(b3)</div>
<div class="line"><span class="lineno">  146</span>    <span class="keyword">assert</span> isinstance(b3_reconstructed, np.ndarray)</div>
<div class="line"><span class="lineno">  147</span>    <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(b3_reconstructed)</div>
<div class="line"><span class="lineno">  148</span>    assert_array_equal(b3_reconstructed, b3)</div>
<div class="line"><span class="lineno">  149</span> </div>
<div class="line"><span class="lineno">  150</span> </div>
<div class="line"><span class="lineno">  151</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  152</span><span class="preprocessor">@skipif((sys.platform != &quot;win32&quot;)</span> <span class="keywordflow">or</span> (),</div>
<div class="line"><span class="lineno">  153</span>        reason=<span class="stringliteral">&quot;PermissionError only easily triggerable on Windows&quot;</span>)</div>
</div><!-- fragment -->
</div>
</div>
<a id="a32bf4cf600632810385a9a3006ce5e57" name="a32bf4cf600632810385a9a3006ce5e57"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a32bf4cf600632810385a9a3006ce5e57">&#9670;&#160;</a></span>test_memmap_returned_as_regular_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmap_returned_as_regular_array </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  640</span><span class="keyword">def </span>test_memmap_returned_as_regular_array(backend):</div>
<div class="line"><span class="lineno">  641</span>    data = np.ones(int(1e3))</div>
<div class="line"><span class="lineno">  642</span>    <span class="comment"># Check that child processes send temporary memmaps back as numpy arrays.</span></div>
<div class="line"><span class="lineno">  643</span>    [result] = Parallel(n_jobs=2, backend=backend, max_nbytes=100)(</div>
<div class="line"><span class="lineno">  644</span>        delayed(check_memmap_and_send_back)(data) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1))</div>
<div class="line"><span class="lineno">  645</span>    <span class="keyword">assert</span> _get_backing_memmap(result) <span class="keywordflow">is</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  646</span> </div>
<div class="line"><span class="lineno">  647</span> </div>
<div class="line"><span class="lineno">  648</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  649</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  650</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a474d79ff81757b0798c498f7e8c9eab3" name="a474d79ff81757b0798c498f7e8c9eab3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a474d79ff81757b0798c498f7e8c9eab3">&#9670;&#160;</a></span>test_memmapping_on_large_enough_dev_shm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_on_large_enough_dev_shm </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that memmapping uses /dev/shm when possible</pre> <div class="fragment"><div class="line"><span class="lineno">  879</span><span class="keyword">def </span>test_memmapping_on_large_enough_dev_shm(factory):</div>
<div class="line"><span class="lineno">  880</span>    <span class="stringliteral">&quot;&quot;&quot;Check that memmapping uses /dev/shm when possible&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  881</span>    orig_size = jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE</div>
<div class="line"><span class="lineno">  882</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  883</span>        <span class="comment"># Make joblib believe that it can use /dev/shm even when running on a</span></div>
<div class="line"><span class="lineno">  884</span>        <span class="comment"># CI container where the size of the /dev/shm is not very large (that</span></div>
<div class="line"><span class="lineno">  885</span>        <span class="comment"># is at least 32 MB instead of 2 GB by default).</span></div>
<div class="line"><span class="lineno">  886</span>        jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE = int(32e6)</div>
<div class="line"><span class="lineno">  887</span>        p = factory(3, max_nbytes=10)</div>
<div class="line"><span class="lineno">  888</span>        <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  889</span>            <span class="comment"># Check that the pool has correctly detected the presence of the</span></div>
<div class="line"><span class="lineno">  890</span>            <span class="comment"># shared memory filesystem.</span></div>
<div class="line"><span class="lineno">  891</span>            pool_temp_folder = p._temp_folder</div>
<div class="line"><span class="lineno">  892</span>            folder_prefix = <span class="stringliteral">&#39;/dev/shm/joblib_memmapping_folder_&#39;</span></div>
<div class="line"><span class="lineno">  893</span>            <span class="keyword">assert</span> pool_temp_folder.startswith(folder_prefix)</div>
<div class="line"><span class="lineno">  894</span>            <span class="keyword">assert</span> os.path.exists(pool_temp_folder)</div>
<div class="line"><span class="lineno">  895</span> </div>
<div class="line"><span class="lineno">  896</span>            <span class="comment"># Try with a file larger than the memmap threshold of 10 bytes</span></div>
<div class="line"><span class="lineno">  897</span>            a = np.ones(100, dtype=np.float64)</div>
<div class="line"><span class="lineno">  898</span>            <span class="keyword">assert</span> a.nbytes == 800</div>
<div class="line"><span class="lineno">  899</span>            p.map(id, [a] * 10)</div>
<div class="line"><span class="lineno">  900</span>            <span class="comment"># a should have been memmapped to the pool temp folder: the joblib</span></div>
<div class="line"><span class="lineno">  901</span>            <span class="comment"># pickling procedure generate one .pkl file:</span></div>
<div class="line"><span class="lineno">  902</span>            <span class="keyword">assert</span> len(os.listdir(pool_temp_folder)) == 1</div>
<div class="line"><span class="lineno">  903</span> </div>
<div class="line"><span class="lineno">  904</span>            <span class="comment"># create a new array with content that is different from &#39;a&#39; so</span></div>
<div class="line"><span class="lineno">  905</span>            <span class="comment"># that it is mapped to a different file in the temporary folder of</span></div>
<div class="line"><span class="lineno">  906</span>            <span class="comment"># the pool.</span></div>
<div class="line"><span class="lineno">  907</span>            b = np.ones(100, dtype=np.float64) * 2</div>
<div class="line"><span class="lineno">  908</span>            <span class="keyword">assert</span> b.nbytes == 800</div>
<div class="line"><span class="lineno">  909</span>            p.map(id, [b] * 10)</div>
<div class="line"><span class="lineno">  910</span>            <span class="comment"># A copy of both a and b are now stored in the shared memory folder</span></div>
<div class="line"><span class="lineno">  911</span>            <span class="keyword">assert</span> len(os.listdir(pool_temp_folder)) == 2</div>
<div class="line"><span class="lineno">  912</span>        <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  913</span>            <span class="comment"># Cleanup open file descriptors</span></div>
<div class="line"><span class="lineno">  914</span>            p.terminate()</div>
<div class="line"><span class="lineno">  915</span>            del p</div>
<div class="line"><span class="lineno">  916</span> </div>
<div class="line"><span class="lineno">  917</span>        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(100):</div>
<div class="line"><span class="lineno">  918</span>            <span class="comment"># The temp folder is cleaned up upon pool termination</span></div>
<div class="line"><span class="lineno">  919</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(pool_temp_folder):</div>
<div class="line"><span class="lineno">  920</span>                <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  921</span>            sleep(.1)</div>
<div class="line"><span class="lineno">  922</span>        <span class="keywordflow">else</span>:  <span class="comment"># pragma: no cover</span></div>
<div class="line"><span class="lineno">  923</span>            <span class="keywordflow">raise</span> AssertionError(<span class="stringliteral">&#39;temporary folder of pool was not deleted&#39;</span>)</div>
<div class="line"><span class="lineno">  924</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  925</span>        jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE = orig_size</div>
<div class="line"><span class="lineno">  926</span> </div>
<div class="line"><span class="lineno">  927</span> </div>
<div class="line"><span class="lineno">  928</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  929</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  930</span><span class="preprocessor">@with_dev_shm</span></div>
<div class="line"><span class="lineno">  931</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  932</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="a8b54e6f21b362180760c153fffa97b0b" name="a8b54e6f21b362180760c153fffa97b0b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8b54e6f21b362180760c153fffa97b0b">&#9670;&#160;</a></span>test_memmapping_on_too_small_dev_shm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_on_too_small_dev_shm </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  933</span><span class="keyword">def </span>test_memmapping_on_too_small_dev_shm(factory):</div>
<div class="line"><span class="lineno">  934</span>    orig_size = jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE</div>
<div class="line"><span class="lineno">  935</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  936</span>        <span class="comment"># Make joblib believe that it cannot use /dev/shm unless there is</span></div>
<div class="line"><span class="lineno">  937</span>        <span class="comment"># 42 exabytes of available shared memory in /dev/shm</span></div>
<div class="line"><span class="lineno">  938</span>        jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE = int(42e18)</div>
<div class="line"><span class="lineno">  939</span> </div>
<div class="line"><span class="lineno">  940</span>        p = factory(3, max_nbytes=10)</div>
<div class="line"><span class="lineno">  941</span>        <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  942</span>            <span class="comment"># Check that the pool has correctly detected the presence of the</span></div>
<div class="line"><span class="lineno">  943</span>            <span class="comment"># shared memory filesystem.</span></div>
<div class="line"><span class="lineno">  944</span>            pool_temp_folder = p._temp_folder</div>
<div class="line"><span class="lineno">  945</span>            <span class="keyword">assert</span> <span class="keywordflow">not</span> pool_temp_folder.startswith(<span class="stringliteral">&#39;/dev/shm&#39;</span>)</div>
<div class="line"><span class="lineno">  946</span>        <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  947</span>            <span class="comment"># Cleanup open file descriptors</span></div>
<div class="line"><span class="lineno">  948</span>            p.terminate()</div>
<div class="line"><span class="lineno">  949</span>            del p</div>
<div class="line"><span class="lineno">  950</span> </div>
<div class="line"><span class="lineno">  951</span>        <span class="comment"># The temp folder is cleaned up upon pool termination</span></div>
<div class="line"><span class="lineno">  952</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> os.path.exists(pool_temp_folder)</div>
<div class="line"><span class="lineno">  953</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  954</span>        jmr.SYSTEM_SHARED_MEM_FS_MIN_SIZE = orig_size</div>
<div class="line"><span class="lineno">  955</span> </div>
<div class="line"><span class="lineno">  956</span> </div>
<div class="line"><span class="lineno">  957</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  958</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  959</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  960</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa44b865da5b0460467933632d42e55a7" name="aa44b865da5b0460467933632d42e55a7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa44b865da5b0460467933632d42e55a7">&#9670;&#160;</a></span>test_memmapping_pool_for_large_arrays()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_pool_for_large_arrays </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that large arrays are not copied in memory</pre> <div class="fragment"><div class="line"><span class="lineno">  707</span><span class="keyword">def </span>test_memmapping_pool_for_large_arrays(factory, tmpdir):</div>
<div class="line"><span class="lineno">  708</span>    <span class="stringliteral">&quot;&quot;&quot;Check that large arrays are not copied in memory&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  709</span> </div>
<div class="line"><span class="lineno">  710</span>    <span class="comment"># Check that the tempfolder is empty</span></div>
<div class="line"><span class="lineno">  711</span>    <span class="keyword">assert</span> os.listdir(tmpdir.strpath) == []</div>
<div class="line"><span class="lineno">  712</span> </div>
<div class="line"><span class="lineno">  713</span>    <span class="comment"># Build an array reducers that automatically dump large array content</span></div>
<div class="line"><span class="lineno">  714</span>    <span class="comment"># to filesystem backed memmap instances to avoid memory explosion</span></div>
<div class="line"><span class="lineno">  715</span>    p = factory(3, max_nbytes=40, temp_folder=tmpdir.strpath, verbose=2)</div>
<div class="line"><span class="lineno">  716</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  717</span>        <span class="comment"># The temporary folder for the pool is not provisioned in advance</span></div>
<div class="line"><span class="lineno">  718</span>        <span class="keyword">assert</span> os.listdir(tmpdir.strpath) == []</div>
<div class="line"><span class="lineno">  719</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> os.path.exists(p._temp_folder)</div>
<div class="line"><span class="lineno">  720</span> </div>
<div class="line"><span class="lineno">  721</span>        small = np.ones(5, dtype=np.float32)</div>
<div class="line"><span class="lineno">  722</span>        <span class="keyword">assert</span> small.nbytes == 20</div>
<div class="line"><span class="lineno">  723</span>        p.map(check_array, [(small, i, 1.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(small.shape[0])])</div>
<div class="line"><span class="lineno">  724</span> </div>
<div class="line"><span class="lineno">  725</span>        <span class="comment"># Memory has been copied, the pool filesystem folder is unused</span></div>
<div class="line"><span class="lineno">  726</span>        <span class="keyword">assert</span> os.listdir(tmpdir.strpath) == []</div>
<div class="line"><span class="lineno">  727</span> </div>
<div class="line"><span class="lineno">  728</span>        <span class="comment"># Try with a file larger than the memmap threshold of 40 bytes</span></div>
<div class="line"><span class="lineno">  729</span>        large = np.ones(100, dtype=np.float64)</div>
<div class="line"><span class="lineno">  730</span>        <span class="keyword">assert</span> large.nbytes == 800</div>
<div class="line"><span class="lineno">  731</span>        p.map(check_array, [(large, i, 1.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(large.shape[0])])</div>
<div class="line"><span class="lineno">  732</span> </div>
<div class="line"><span class="lineno">  733</span>        <span class="comment"># The data has been dumped in a temp folder for subprocess to share it</span></div>
<div class="line"><span class="lineno">  734</span>        <span class="comment"># without per-child memory copies</span></div>
<div class="line"><span class="lineno">  735</span>        <span class="keyword">assert</span> os.path.isdir(p._temp_folder)</div>
<div class="line"><span class="lineno">  736</span>        dumped_filenames = os.listdir(p._temp_folder)</div>
<div class="line"><span class="lineno">  737</span>        <span class="keyword">assert</span> len(dumped_filenames) == 1</div>
<div class="line"><span class="lineno">  738</span> </div>
<div class="line"><span class="lineno">  739</span>        <span class="comment"># Check that memory mapping is not triggered for arrays with</span></div>
<div class="line"><span class="lineno">  740</span>        <span class="comment"># dtype=&#39;object&#39;</span></div>
<div class="line"><span class="lineno">  741</span>        objects = np.array([<span class="stringliteral">&#39;abc&#39;</span>] * 100, dtype=<span class="stringliteral">&#39;object&#39;</span>)</div>
<div class="line"><span class="lineno">  742</span>        results = p.map(has_shareable_memory, [objects])</div>
<div class="line"><span class="lineno">  743</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> results[0]</div>
<div class="line"><span class="lineno">  744</span> </div>
<div class="line"><span class="lineno">  745</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  746</span>        <span class="comment"># check FS garbage upon pool termination</span></div>
<div class="line"><span class="lineno">  747</span>        p.terminate()</div>
<div class="line"><span class="lineno">  748</span>        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(10):</div>
<div class="line"><span class="lineno">  749</span>            sleep(.1)</div>
<div class="line"><span class="lineno">  750</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(p._temp_folder):</div>
<div class="line"><span class="lineno">  751</span>                <span class="keywordflow">break</span></div>
<div class="line"><span class="lineno">  752</span>        <span class="keywordflow">else</span>:  <span class="comment"># pragma: no cover</span></div>
<div class="line"><span class="lineno">  753</span>            <span class="keywordflow">raise</span> AssertionError(</div>
<div class="line"><span class="lineno">  754</span>                <span class="stringliteral">&#39;temporary folder of {} was not deleted&#39;</span>.format(p)</div>
<div class="line"><span class="lineno">  755</span>            )</div>
<div class="line"><span class="lineno">  756</span>        del p</div>
<div class="line"><span class="lineno">  757</span> </div>
<div class="line"><span class="lineno">  758</span> </div>
<div class="line"><span class="lineno">  759</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  760</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  761</span><span class="preprocessor">@parametrize</span>(</div>
<div class="line"><span class="lineno">  762</span>    <span class="stringliteral">&quot;backend&quot;</span>,</div>
<div class="line"><span class="lineno">  763</span>    [</div>
<div class="line"><span class="lineno">  764</span>        pytest.param(</div>
<div class="line"><span class="lineno">  765</span>            <span class="stringliteral">&quot;multiprocessing&quot;</span>,</div>
<div class="line"><span class="lineno">  766</span>            marks=pytest.mark.xfail(</div>
<div class="line"><span class="lineno">  767</span>                reason=<span class="stringliteral">&#39;https://github.com/joblib/joblib/issues/1086&#39;</span></div>
<div class="line"><span class="lineno">  768</span>            ),</div>
<div class="line"><span class="lineno">  769</span>        ),</div>
<div class="line"><span class="lineno">  770</span>        <span class="stringliteral">&quot;loky&quot;</span>,</div>
<div class="line"><span class="lineno">  771</span>    ]</div>
<div class="line"><span class="lineno">  772</span>)</div>
</div><!-- fragment -->
</div>
</div>
<a id="a2c36922b42abf2300071b97d9db4d252" name="a2c36922b42abf2300071b97d9db4d252"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2c36922b42abf2300071b97d9db4d252">&#9670;&#160;</a></span>test_memmapping_pool_for_large_arrays_disabled()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_pool_for_large_arrays_disabled </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that large arrays memmapping can be disabled</pre> <div class="fragment"><div class="line"><span class="lineno">  851</span><span class="keyword">def </span>test_memmapping_pool_for_large_arrays_disabled(factory, tmpdir):</div>
<div class="line"><span class="lineno">  852</span>    <span class="stringliteral">&quot;&quot;&quot;Check that large arrays memmapping can be disabled&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  853</span>    <span class="comment"># Set max_nbytes to None to disable the auto memmapping feature</span></div>
<div class="line"><span class="lineno">  854</span>    p = factory(3, max_nbytes=<span class="keywordtype">None</span>, temp_folder=tmpdir.strpath)</div>
<div class="line"><span class="lineno">  855</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  856</span> </div>
<div class="line"><span class="lineno">  857</span>        <span class="comment"># Check that the tempfolder is empty</span></div>
<div class="line"><span class="lineno">  858</span>        <span class="keyword">assert</span> os.listdir(tmpdir.strpath) == []</div>
<div class="line"><span class="lineno">  859</span> </div>
<div class="line"><span class="lineno">  860</span>        <span class="comment"># Try with a file largish than the memmap threshold of 40 bytes</span></div>
<div class="line"><span class="lineno">  861</span>        large = np.ones(100, dtype=np.float64)</div>
<div class="line"><span class="lineno">  862</span>        <span class="keyword">assert</span> large.nbytes == 800</div>
<div class="line"><span class="lineno">  863</span>        p.map(check_array, [(large, i, 1.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(large.shape[0])])</div>
<div class="line"><span class="lineno">  864</span> </div>
<div class="line"><span class="lineno">  865</span>        <span class="comment"># Check that the tempfolder is still empty</span></div>
<div class="line"><span class="lineno">  866</span>        <span class="keyword">assert</span> os.listdir(tmpdir.strpath) == []</div>
<div class="line"><span class="lineno">  867</span> </div>
<div class="line"><span class="lineno">  868</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  869</span>        <span class="comment"># Cleanup open file descriptors</span></div>
<div class="line"><span class="lineno">  870</span>        p.terminate()</div>
<div class="line"><span class="lineno">  871</span>        del p</div>
<div class="line"><span class="lineno">  872</span> </div>
<div class="line"><span class="lineno">  873</span> </div>
<div class="line"><span class="lineno">  874</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  875</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  876</span><span class="preprocessor">@with_dev_shm</span></div>
<div class="line"><span class="lineno">  877</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  878</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="af4c21c6e439a1af030e80fb9de68f724" name="af4c21c6e439a1af030e80fb9de68f724"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4c21c6e439a1af030e80fb9de68f724">&#9670;&#160;</a></span>test_memmapping_pool_for_large_arrays_in_return()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_pool_for_large_arrays_in_return </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that large arrays are not copied in memory in return</pre> <div class="fragment"><div class="line"><span class="lineno">  961</span><span class="keyword">def </span>test_memmapping_pool_for_large_arrays_in_return(factory, tmpdir):</div>
<div class="line"><span class="lineno">  962</span>    <span class="stringliteral">&quot;&quot;&quot;Check that large arrays are not copied in memory in return&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  963</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno">  964</span> </div>
<div class="line"><span class="lineno">  965</span>    <span class="comment"># Build an array reducers that automatically dump large array content</span></div>
<div class="line"><span class="lineno">  966</span>    <span class="comment"># but check that the returned datastructure are regular arrays to avoid</span></div>
<div class="line"><span class="lineno">  967</span>    <span class="comment"># passing a memmap array pointing to a pool controlled temp folder that</span></div>
<div class="line"><span class="lineno">  968</span>    <span class="comment"># might be confusing to the user</span></div>
<div class="line"><span class="lineno">  969</span> </div>
<div class="line"><span class="lineno">  970</span>    <span class="comment"># The MemmappingPool user can always return numpy.memmap object explicitly</span></div>
<div class="line"><span class="lineno">  971</span>    <span class="comment"># to avoid memory copy</span></div>
<div class="line"><span class="lineno">  972</span>    p = factory(3, max_nbytes=10, temp_folder=tmpdir.strpath)</div>
<div class="line"><span class="lineno">  973</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  974</span>        res = p.apply_async(np.ones, args=(1000,))</div>
<div class="line"><span class="lineno">  975</span>        large = res.get()</div>
<div class="line"><span class="lineno">  976</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(large)</div>
<div class="line"><span class="lineno">  977</span>        assert_array_equal(large, np.ones(1000))</div>
<div class="line"><span class="lineno">  978</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  979</span>        p.terminate()</div>
<div class="line"><span class="lineno">  980</span>        del p</div>
<div class="line"><span class="lineno">  981</span> </div>
<div class="line"><span class="lineno">  982</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a435d887373a2cc185297c063a3d2edc9" name="a435d887373a2cc185297c063a3d2edc9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a435d887373a2cc185297c063a3d2edc9">&#9670;&#160;</a></span>test_memmapping_temp_folder_thread_safety()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_memmapping_temp_folder_thread_safety </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  479</span><span class="keyword">def </span>test_memmapping_temp_folder_thread_safety():</div>
<div class="line"><span class="lineno">  480</span>    <span class="comment"># Concurrent calls to Parallel with the loky backend will use the same</span></div>
<div class="line"><span class="lineno">  481</span>    <span class="comment"># executor, and thus the same reducers. Make sure that those reducers use</span></div>
<div class="line"><span class="lineno">  482</span>    <span class="comment"># different temporary folders depending on which Parallel objects called</span></div>
<div class="line"><span class="lineno">  483</span>    <span class="comment"># them, which is necessary to limit potential race conditions during the</span></div>
<div class="line"><span class="lineno">  484</span>    <span class="comment"># garbage collection of temporary memmaps.</span></div>
<div class="line"><span class="lineno">  485</span>    array = np.arange(int(1e2))</div>
<div class="line"><span class="lineno">  486</span> </div>
<div class="line"><span class="lineno">  487</span>    temp_dirs_thread_1 = set()</div>
<div class="line"><span class="lineno">  488</span>    temp_dirs_thread_2 = set()</div>
<div class="line"><span class="lineno">  489</span> </div>
<div class="line"><span class="lineno">  490</span>    <span class="keyword">def </span>concurrent_get_filename(array, temp_dirs):</div>
<div class="line"><span class="lineno">  491</span>        <span class="keyword">with</span> Parallel(backend=<span class="stringliteral">&#39;loky&#39;</span>, n_jobs=2, max_nbytes=10) <span class="keyword">as</span> p:</div>
<div class="line"><span class="lineno">  492</span>            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(10):</div>
<div class="line"><span class="lineno">  493</span>                [filename] = p(</div>
<div class="line"><span class="lineno">  494</span>                    delayed(getattr)(array, <span class="stringliteral">&#39;filename&#39;</span>) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1)</div>
<div class="line"><span class="lineno">  495</span>                )</div>
<div class="line"><span class="lineno">  496</span>                temp_dirs.add(os.path.dirname(filename))</div>
<div class="line"><span class="lineno">  497</span> </div>
<div class="line"><span class="lineno">  498</span>    t1 = threading.Thread(</div>
<div class="line"><span class="lineno">  499</span>        target=concurrent_get_filename, args=(array, temp_dirs_thread_1)</div>
<div class="line"><span class="lineno">  500</span>    )</div>
<div class="line"><span class="lineno">  501</span>    t2 = threading.Thread(</div>
<div class="line"><span class="lineno">  502</span>        target=concurrent_get_filename, args=(array, temp_dirs_thread_2)</div>
<div class="line"><span class="lineno">  503</span>    )</div>
<div class="line"><span class="lineno">  504</span> </div>
<div class="line"><span class="lineno">  505</span>    t1.start()</div>
<div class="line"><span class="lineno">  506</span>    t2.start()</div>
<div class="line"><span class="lineno">  507</span> </div>
<div class="line"><span class="lineno">  508</span>    t1.join()</div>
<div class="line"><span class="lineno">  509</span>    t2.join()</div>
<div class="line"><span class="lineno">  510</span> </div>
<div class="line"><span class="lineno">  511</span>    <span class="keyword">assert</span> len(temp_dirs_thread_1) == 1</div>
<div class="line"><span class="lineno">  512</span>    <span class="keyword">assert</span> len(temp_dirs_thread_2) == 1</div>
<div class="line"><span class="lineno">  513</span> </div>
<div class="line"><span class="lineno">  514</span>    <span class="keyword">assert</span> temp_dirs_thread_1 != temp_dirs_thread_2</div>
<div class="line"><span class="lineno">  515</span> </div>
<div class="line"><span class="lineno">  516</span> </div>
<div class="line"><span class="lineno">  517</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  518</span><span class="preprocessor">@with_multiprocessing</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1749b73a6584eac4641671f8f9946d7a" name="a1749b73a6584eac4641671f8f9946d7a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1749b73a6584eac4641671f8f9946d7a">&#9670;&#160;</a></span>test_multithreaded_parallel_termination_resource_tracker_silent()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_multithreaded_parallel_termination_resource_tracker_silent </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  519</span><span class="keyword">def </span>test_multithreaded_parallel_termination_resource_tracker_silent():</div>
<div class="line"><span class="lineno">  520</span>    <span class="comment"># test that concurrent termination attempts of a same executor does not</span></div>
<div class="line"><span class="lineno">  521</span>    <span class="comment"># emit any spurious error from the resource_tracker. We test various</span></div>
<div class="line"><span class="lineno">  522</span>    <span class="comment"># situations making 0, 1 or both parallel call sending a task that will</span></div>
<div class="line"><span class="lineno">  523</span>    <span class="comment"># make the worker (and thus the whole Parallel call) error out.</span></div>
<div class="line"><span class="lineno">  524</span>    cmd = <span class="stringliteral">&#39;&#39;&#39;if 1:</span></div>
<div class="line"><span class="lineno">  525</span><span class="stringliteral">        import os</span></div>
<div class="line"><span class="lineno">  526</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  527</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  528</span><span class="stringliteral">        from joblib.externals.loky.backend import resource_tracker</span></div>
<div class="line"><span class="lineno">  529</span><span class="stringliteral">        from concurrent.futures import ThreadPoolExecutor, wait</span></div>
<div class="line"><span class="lineno">  530</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  531</span><span class="stringliteral">        resource_tracker.VERBOSE = 0</span></div>
<div class="line"><span class="lineno">  532</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  533</span><span class="stringliteral">        array = np.arange(int(1e2))</span></div>
<div class="line"><span class="lineno">  534</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  535</span><span class="stringliteral">        temp_dirs_thread_1 = set()</span></div>
<div class="line"><span class="lineno">  536</span><span class="stringliteral">        temp_dirs_thread_2 = set()</span></div>
<div class="line"><span class="lineno">  537</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  538</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  539</span><span class="stringliteral">        def raise_error(array):</span></div>
<div class="line"><span class="lineno">  540</span><span class="stringliteral">            raise ValueError</span></div>
<div class="line"><span class="lineno">  541</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  542</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  543</span><span class="stringliteral">        def parallel_get_filename(array, temp_dirs):</span></div>
<div class="line"><span class="lineno">  544</span><span class="stringliteral">            with Parallel(backend=&quot;loky&quot;, n_jobs=2, max_nbytes=10) as p:</span></div>
<div class="line"><span class="lineno">  545</span><span class="stringliteral">                for i in range(10):</span></div>
<div class="line"><span class="lineno">  546</span><span class="stringliteral">                    [filename] = p(</span></div>
<div class="line"><span class="lineno">  547</span><span class="stringliteral">                        delayed(getattr)(array, &quot;filename&quot;) for _ in range(1)</span></div>
<div class="line"><span class="lineno">  548</span><span class="stringliteral">                    )</span></div>
<div class="line"><span class="lineno">  549</span><span class="stringliteral">                    temp_dirs.add(os.path.dirname(filename))</span></div>
<div class="line"><span class="lineno">  550</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  551</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  552</span><span class="stringliteral">        def parallel_raise(array, temp_dirs):</span></div>
<div class="line"><span class="lineno">  553</span><span class="stringliteral">            with Parallel(backend=&quot;loky&quot;, n_jobs=2, max_nbytes=10) as p:</span></div>
<div class="line"><span class="lineno">  554</span><span class="stringliteral">                for i in range(10):</span></div>
<div class="line"><span class="lineno">  555</span><span class="stringliteral">                    [filename] = p(</span></div>
<div class="line"><span class="lineno">  556</span><span class="stringliteral">                        delayed(raise_error)(array) for _ in range(1)</span></div>
<div class="line"><span class="lineno">  557</span><span class="stringliteral">                    )</span></div>
<div class="line"><span class="lineno">  558</span><span class="stringliteral">                    temp_dirs.add(os.path.dirname(filename))</span></div>
<div class="line"><span class="lineno">  559</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  560</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  561</span><span class="stringliteral">        executor = ThreadPoolExecutor(max_workers=2)</span></div>
<div class="line"><span class="lineno">  562</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  563</span><span class="stringliteral">        # both function calls will use the same loky executor, but with a</span></div>
<div class="line"><span class="lineno">  564</span><span class="stringliteral">        # different Parallel object.</span></div>
<div class="line"><span class="lineno">  565</span><span class="stringliteral">        future_1 = executor.submit({f1}, array, temp_dirs_thread_1)</span></div>
<div class="line"><span class="lineno">  566</span><span class="stringliteral">        future_2 = executor.submit({f2}, array, temp_dirs_thread_2)</span></div>
<div class="line"><span class="lineno">  567</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  568</span><span class="stringliteral">        # Wait for both threads to terminate their backend</span></div>
<div class="line"><span class="lineno">  569</span><span class="stringliteral">        wait([future_1, future_2])</span></div>
<div class="line"><span class="lineno">  570</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  571</span><span class="stringliteral">        future_1.result()</span></div>
<div class="line"><span class="lineno">  572</span><span class="stringliteral">        future_2.result()</span></div>
<div class="line"><span class="lineno">  573</span><span class="stringliteral">    &#39;&#39;&#39;</span></div>
<div class="line"><span class="lineno">  574</span>    functions_and_returncodes = [</div>
<div class="line"><span class="lineno">  575</span>        (<span class="stringliteral">&quot;parallel_get_filename&quot;</span>, <span class="stringliteral">&quot;parallel_get_filename&quot;</span>, 0),</div>
<div class="line"><span class="lineno">  576</span>        (<span class="stringliteral">&quot;parallel_get_filename&quot;</span>, <span class="stringliteral">&quot;parallel_raise&quot;</span>, 1),</div>
<div class="line"><span class="lineno">  577</span>        (<span class="stringliteral">&quot;parallel_raise&quot;</span>, <span class="stringliteral">&quot;parallel_raise&quot;</span>, 1)</div>
<div class="line"><span class="lineno">  578</span>    ]</div>
<div class="line"><span class="lineno">  579</span> </div>
<div class="line"><span class="lineno">  580</span>    <span class="keywordflow">for</span> f1, f2, returncode <span class="keywordflow">in</span> functions_and_returncodes:</div>
<div class="line"><span class="lineno">  581</span>        p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd.format(f1=f1, f2=f2)],</div>
<div class="line"><span class="lineno">  582</span>                             stderr=subprocess.PIPE, stdout=subprocess.PIPE)</div>
<div class="line"><span class="lineno">  583</span>        p.wait()</div>
<div class="line"><span class="lineno">  584</span>        out, err = p.communicate()</div>
<div class="line"><span class="lineno">  585</span>        <span class="keyword">assert</span> p.returncode == returncode, out.decode()</div>
<div class="line"><span class="lineno">  586</span>        <span class="keyword">assert</span> b<span class="stringliteral">&quot;resource_tracker&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> err, err.decode()</div>
<div class="line"><span class="lineno">  587</span> </div>
<div class="line"><span class="lineno">  588</span> </div>
<div class="line"><span class="lineno">  589</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  590</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  591</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="aad788198801245230bc3e5d720f562b5" name="aad788198801245230bc3e5d720f562b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aad788198801245230bc3e5d720f562b5">&#9670;&#160;</a></span>test_numpy_arrays_use_different_memory()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_numpy_arrays_use_different_memory </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>mmap_mode</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1065</span><span class="keyword">def </span>test_numpy_arrays_use_different_memory(mmap_mode):</div>
<div class="line"><span class="lineno"> 1066</span>    <span class="keyword">def </span><a class="code hl_function" href="callback_2foo_8f.html#a565fe2cc583df102f120752b0011c330">func</a>(arr, value):</div>
<div class="line"><span class="lineno"> 1067</span>        arr[:] = value</div>
<div class="line"><span class="lineno"> 1068</span>        <span class="keywordflow">return</span> arr</div>
<div class="line"><span class="lineno"> 1069</span> </div>
<div class="line"><span class="lineno"> 1070</span>    arrays = [np.zeros((10, 10), dtype=<span class="stringliteral">&#39;float64&#39;</span>) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(10)]</div>
<div class="line"><span class="lineno"> 1071</span> </div>
<div class="line"><span class="lineno"> 1072</span>    results = Parallel(mmap_mode=mmap_mode, max_nbytes=0, n_jobs=2)(</div>
<div class="line"><span class="lineno"> 1073</span>        delayed(func)(arr, i) <span class="keywordflow">for</span> i, arr <span class="keywordflow">in</span> enumerate(arrays))</div>
<div class="line"><span class="lineno"> 1074</span> </div>
<div class="line"><span class="lineno"> 1075</span>    <span class="keywordflow">for</span> i, arr <span class="keywordflow">in</span> enumerate(results):</div>
<div class="line"><span class="lineno"> 1076</span>        np.testing.assert_array_equal(arr, i)</div>
<div class="line"><span class="lineno"> 1077</span> </div>
<div class="line"><span class="lineno"> 1078</span> </div>
<div class="line"><span class="lineno"> 1079</span><span class="preprocessor">@with_numpy</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3e1b3d4371cdf6cc2b68a4aedb416a5f" name="a3e1b3d4371cdf6cc2b68a4aedb416a5f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e1b3d4371cdf6cc2b68a4aedb416a5f">&#9670;&#160;</a></span>test_parallel_isolated_temp_folders()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_parallel_isolated_temp_folders </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  448</span><span class="keyword">def </span>test_parallel_isolated_temp_folders(backend):</div>
<div class="line"><span class="lineno">  449</span>    <span class="comment"># Test that consecutive Parallel call use isolated subfolders, even</span></div>
<div class="line"><span class="lineno">  450</span>    <span class="comment"># for the loky backend that reuses its executor instance across calls.</span></div>
<div class="line"><span class="lineno">  451</span>    array = np.arange(int(1e2))</div>
<div class="line"><span class="lineno">  452</span>    [filename_1] = Parallel(n_jobs=2, backend=backend, max_nbytes=10)(</div>
<div class="line"><span class="lineno">  453</span>        delayed(getattr)(array, <span class="stringliteral">&#39;filename&#39;</span>) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1)</div>
<div class="line"><span class="lineno">  454</span>    )</div>
<div class="line"><span class="lineno">  455</span>    [filename_2] = Parallel(n_jobs=2, backend=backend, max_nbytes=10)(</div>
<div class="line"><span class="lineno">  456</span>        delayed(getattr)(array, <span class="stringliteral">&#39;filename&#39;</span>) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1)</div>
<div class="line"><span class="lineno">  457</span>    )</div>
<div class="line"><span class="lineno">  458</span>    <span class="keyword">assert</span> os.path.dirname(filename_2) != os.path.dirname(filename_1)</div>
<div class="line"><span class="lineno">  459</span> </div>
<div class="line"><span class="lineno">  460</span> </div>
<div class="line"><span class="lineno">  461</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  462</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  463</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="aad9462252ffb1edceac92d04b977734c" name="aad9462252ffb1edceac92d04b977734c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aad9462252ffb1edceac92d04b977734c">&#9670;&#160;</a></span>test_permission_error_windows_memmap_sent_to_parent()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_permission_error_windows_memmap_sent_to_parent </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  398</span><span class="keyword">def </span>test_permission_error_windows_memmap_sent_to_parent(backend):</div>
<div class="line"><span class="lineno">  399</span>    <span class="comment"># Second non-regression test for:</span></div>
<div class="line"><span class="lineno">  400</span>    <span class="comment"># https://github.com/joblib/joblib/issues/806</span></div>
<div class="line"><span class="lineno">  401</span>    <span class="comment"># previously, child process would not convert temporary memmaps to numpy</span></div>
<div class="line"><span class="lineno">  402</span>    <span class="comment"># arrays when sending the data back to the parent process. This would lead</span></div>
<div class="line"><span class="lineno">  403</span>    <span class="comment"># to permission errors on windows when deleting joblib&#39;s temporary folder,</span></div>
<div class="line"><span class="lineno">  404</span>    <span class="comment"># as the memmaped files handles would still opened in the parent process.</span></div>
<div class="line"><span class="lineno">  405</span>    cmd = <span class="stringliteral">&#39;&#39;&#39;if 1:</span></div>
<div class="line"><span class="lineno">  406</span><span class="stringliteral">        import os</span></div>
<div class="line"><span class="lineno">  407</span><span class="stringliteral">        import time</span></div>
<div class="line"><span class="lineno">  408</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  409</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  410</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  411</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  412</span><span class="stringliteral">        from testutils import return_slice_of_data</span></div>
<div class="line"><span class="lineno">  413</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  414</span><span class="stringliteral">        data = np.ones(int(2e6))</span></div>
<div class="line"><span class="lineno">  415</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  416</span><span class="stringliteral">        if __name__ == &#39;__main__&#39;:</span></div>
<div class="line"><span class="lineno">  417</span><span class="stringliteral">            # warm-up call to launch the workers and start the resource_tracker</span></div>
<div class="line"><span class="lineno">  418</span><span class="stringliteral">            _ = Parallel(n_jobs=2, verbose=5, backend=&#39;{b}&#39;)(</span></div>
<div class="line"><span class="lineno">  419</span><span class="stringliteral">                delayed(id)(i) for i in range(20))</span></div>
<div class="line"><span class="lineno">  420</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  421</span><span class="stringliteral">            time.sleep(0.5)</span></div>
<div class="line"><span class="lineno">  422</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  423</span><span class="stringliteral">            slice_of_data = Parallel(n_jobs=2, verbose=5, backend=&#39;{b}&#39;)(</span></div>
<div class="line"><span class="lineno">  424</span><span class="stringliteral">                delayed(return_slice_of_data)(data, 0, 20) for _ in range(10))</span></div>
<div class="line"><span class="lineno">  425</span><span class="stringliteral">    &#39;&#39;&#39;</span>.format(b=backend)</div>
<div class="line"><span class="lineno">  426</span> </div>
<div class="line"><span class="lineno">  427</span>    <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(3):</div>
<div class="line"><span class="lineno">  428</span>        env = os.environ.copy()</div>
<div class="line"><span class="lineno">  429</span>        env[<span class="stringliteral">&#39;PYTHONPATH&#39;</span>] = os.path.dirname(__file__)</div>
<div class="line"><span class="lineno">  430</span>        p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd],</div>
<div class="line"><span class="lineno">  431</span>                             stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  432</span>                             stdout=subprocess.PIPE, env=env)</div>
<div class="line"><span class="lineno">  433</span>        p.wait()</div>
<div class="line"><span class="lineno">  434</span>        out, err = p.communicate()</div>
<div class="line"><span class="lineno">  435</span>        <span class="keyword">assert</span> p.returncode == 0, err</div>
<div class="line"><span class="lineno">  436</span>        <span class="keyword">assert</span> out == b<span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><span class="lineno">  437</span>        <span class="keywordflow">if</span> sys.version_info[:3] <span class="keywordflow">not</span> <span class="keywordflow">in</span> [(3, 8, 0), (3, 8, 1)]:</div>
<div class="line"><span class="lineno">  438</span>            <span class="comment"># In early versions of Python 3.8, a reference leak</span></div>
<div class="line"><span class="lineno">  439</span>            <span class="comment"># https://github.com/cloudpipe/cloudpickle/issues/327, holds</span></div>
<div class="line"><span class="lineno">  440</span>            <span class="comment"># references to pickled objects, generating race condition during</span></div>
<div class="line"><span class="lineno">  441</span>            <span class="comment"># cleanup finalizers of joblib and noisy resource_tracker outputs.</span></div>
<div class="line"><span class="lineno">  442</span>            <span class="keyword">assert</span> b<span class="stringliteral">&#39;resource_tracker&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> err</div>
<div class="line"><span class="lineno">  443</span> </div>
<div class="line"><span class="lineno">  444</span> </div>
<div class="line"><span class="lineno">  445</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  446</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  447</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="aca45de4ba625362ecc90d133f85f3ea4" name="aca45de4ba625362ecc90d133f85f3ea4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aca45de4ba625362ecc90d133f85f3ea4">&#9670;&#160;</a></span>test_permission_error_windows_reference_cycle()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_permission_error_windows_reference_cycle </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  363</span><span class="keyword">def </span>test_permission_error_windows_reference_cycle(backend):</div>
<div class="line"><span class="lineno">  364</span>    <span class="comment"># Non regression test for:</span></div>
<div class="line"><span class="lineno">  365</span>    <span class="comment"># https://github.com/joblib/joblib/issues/806</span></div>
<div class="line"><span class="lineno">  366</span>    <span class="comment">#</span></div>
<div class="line"><span class="lineno">  367</span>    <span class="comment"># The issue happens when trying to delete a memory mapped file that has</span></div>
<div class="line"><span class="lineno">  368</span>    <span class="comment"># not yet been closed by one of the worker processes.</span></div>
<div class="line"><span class="lineno">  369</span>    cmd = <span class="stringliteral">&quot;&quot;&quot;if 1:</span></div>
<div class="line"><span class="lineno">  370</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  371</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  372</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  373</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  374</span><span class="stringliteral">        data = np.random.rand(int(2e6)).reshape((int(1e6), 2))</span></div>
<div class="line"><span class="lineno">  375</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  376</span><span class="stringliteral">        # Build a complex cyclic reference that is likely to delay garbage</span></div>
<div class="line"><span class="lineno">  377</span><span class="stringliteral">        # collection of the memmapped array in the worker processes.</span></div>
<div class="line"><span class="lineno">  378</span><span class="stringliteral">        first_list = current_list = [data]</span></div>
<div class="line"><span class="lineno">  379</span><span class="stringliteral">        for i in range(10):</span></div>
<div class="line"><span class="lineno">  380</span><span class="stringliteral">            current_list = [current_list]</span></div>
<div class="line"><span class="lineno">  381</span><span class="stringliteral">        first_list.append(current_list)</span></div>
<div class="line"><span class="lineno">  382</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  383</span><span class="stringliteral">        if __name__ == &quot;__main__&quot;:</span></div>
<div class="line"><span class="lineno">  384</span><span class="stringliteral">            results = Parallel(n_jobs=2, backend=&quot;{b}&quot;)(</span></div>
<div class="line"><span class="lineno">  385</span><span class="stringliteral">                delayed(len)(current_list) for i in range(10))</span></div>
<div class="line"><span class="lineno">  386</span><span class="stringliteral">            assert results == [1] * 10</span></div>
<div class="line"><span class="lineno">  387</span><span class="stringliteral">    &quot;&quot;&quot;</span>.format(b=backend)</div>
<div class="line"><span class="lineno">  388</span>    p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd], stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  389</span>                         stdout=subprocess.PIPE)</div>
<div class="line"><span class="lineno">  390</span>    p.wait()</div>
<div class="line"><span class="lineno">  391</span>    out, err = p.communicate()</div>
<div class="line"><span class="lineno">  392</span>    <span class="keyword">assert</span> p.returncode == 0, out.decode() + <span class="stringliteral">&quot;\n\n&quot;</span> + err.decode()</div>
<div class="line"><span class="lineno">  393</span> </div>
<div class="line"><span class="lineno">  394</span> </div>
<div class="line"><span class="lineno">  395</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  396</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  397</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad535a3d8b4915968bad70577a1d429f3" name="ad535a3d8b4915968bad70577a1d429f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad535a3d8b4915968bad70577a1d429f3">&#9670;&#160;</a></span>test_pool_get_temp_dir()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_pool_get_temp_dir </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1049</span><span class="keyword">def </span>test_pool_get_temp_dir(tmpdir):</div>
<div class="line"><span class="lineno"> 1050</span>    pool_folder_name = <span class="stringliteral">&#39;test.tmpdir&#39;</span></div>
<div class="line"><span class="lineno"> 1051</span>    pool_folder, shared_mem = _get_temp_dir(pool_folder_name, tmpdir.strpath)</div>
<div class="line"><span class="lineno"> 1052</span>    <span class="keyword">assert</span> shared_mem <span class="keywordflow">is</span> <span class="keyword">False</span></div>
<div class="line"><span class="lineno"> 1053</span>    <span class="keyword">assert</span> pool_folder == tmpdir.join(<span class="stringliteral">&#39;test.tmpdir&#39;</span>).strpath</div>
<div class="line"><span class="lineno"> 1054</span> </div>
<div class="line"><span class="lineno"> 1055</span>    pool_folder, shared_mem = _get_temp_dir(pool_folder_name, temp_folder=<span class="keywordtype">None</span>)</div>
<div class="line"><span class="lineno"> 1056</span>    <span class="keywordflow">if</span> sys.platform.startswith(<span class="stringliteral">&#39;win&#39;</span>):</div>
<div class="line"><span class="lineno"> 1057</span>        <span class="keyword">assert</span> shared_mem <span class="keywordflow">is</span> <span class="keyword">False</span></div>
<div class="line"><span class="lineno"> 1058</span>    <span class="keyword">assert</span> pool_folder.endswith(pool_folder_name)</div>
<div class="line"><span class="lineno"> 1059</span> </div>
<div class="line"><span class="lineno"> 1060</span> </div>
<div class="line"><span class="lineno"> 1061</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno"> 1062</span><span class="preprocessor">@skipif</span>(sys.platform == <span class="stringliteral">&#39;win32&#39;</span>, reason=<span class="stringliteral">&#39;This test fails with a &#39;</span></div>
<div class="line"><span class="lineno"> 1063</span>        <span class="stringliteral">&#39;PermissionError on Windows&#39;</span>)</div>
<div class="line"><span class="lineno"> 1064</span><span class="preprocessor">@parametrize(&quot;mmap_mode&quot;, [&quot;r+&quot;, &quot;w+&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae724fc0a6952d60b2080a82a551f4f17" name="ae724fc0a6952d60b2080a82a551f4f17"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae724fc0a6952d60b2080a82a551f4f17">&#9670;&#160;</a></span>test_pool_memmap_with_big_offset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_pool_memmap_with_big_offset </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>retry_no</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1030</span><span class="keyword">def </span>test_pool_memmap_with_big_offset(factory, retry_no, tmpdir):</div>
<div class="line"><span class="lineno"> 1031</span>    <span class="comment"># Test that numpy memmap offset is set correctly if greater than</span></div>
<div class="line"><span class="lineno"> 1032</span>    <span class="comment"># mmap.ALLOCATIONGRANULARITY, see</span></div>
<div class="line"><span class="lineno"> 1033</span>    <span class="comment"># https://github.com/joblib/joblib/issues/451 and</span></div>
<div class="line"><span class="lineno"> 1034</span>    <span class="comment"># https://github.com/numpy/numpy/pull/8443 for more details.</span></div>
<div class="line"><span class="lineno"> 1035</span>    fname = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno"> 1036</span>    size = 5 * mmap.ALLOCATIONGRANULARITY</div>
<div class="line"><span class="lineno"> 1037</span>    offset = mmap.ALLOCATIONGRANULARITY + 1</div>
<div class="line"><span class="lineno"> 1038</span>    obj = make_memmap(fname, mode=<span class="stringliteral">&#39;w+&#39;</span>, shape=size, dtype=<span class="stringliteral">&#39;uint8&#39;</span>,</div>
<div class="line"><span class="lineno"> 1039</span>                      offset=offset)</div>
<div class="line"><span class="lineno"> 1040</span> </div>
<div class="line"><span class="lineno"> 1041</span>    p = factory(2, temp_folder=tmpdir.strpath)</div>
<div class="line"><span class="lineno"> 1042</span>    result = p.apply_async(identity, args=(obj,)).get()</div>
<div class="line"><span class="lineno"> 1043</span>    <span class="keyword">assert</span> isinstance(result, np.memmap)</div>
<div class="line"><span class="lineno"> 1044</span>    <span class="keyword">assert</span> result.offset == offset</div>
<div class="line"><span class="lineno"> 1045</span>    np.testing.assert_array_equal(obj, result)</div>
<div class="line"><span class="lineno"> 1046</span>    p.terminate()</div>
<div class="line"><span class="lineno"> 1047</span> </div>
<div class="line"><span class="lineno"> 1048</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a2fc78072ce9fe3799ef3ffc3ee722e31" name="a2fc78072ce9fe3799ef3ffc3ee722e31"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2fc78072ce9fe3799ef3ffc3ee722e31">&#9670;&#160;</a></span>test_pool_with_memmap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_pool_with_memmap </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that subprocess can access and update shared memory memmap</pre> <div class="fragment"><div class="line"><span class="lineno">  271</span><span class="keyword">def </span>test_pool_with_memmap(factory, tmpdir):</div>
<div class="line"><span class="lineno">  272</span>    <span class="stringliteral">&quot;&quot;&quot;Check that subprocess can access and update shared memory memmap&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  273</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno">  274</span> </div>
<div class="line"><span class="lineno">  275</span>    <span class="comment"># Fork the subprocess before allocating the objects to be passed</span></div>
<div class="line"><span class="lineno">  276</span>    pool_temp_folder = tmpdir.mkdir(<span class="stringliteral">&#39;pool&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  277</span>    p = factory(10, max_nbytes=2, temp_folder=pool_temp_folder)</div>
<div class="line"><span class="lineno">  278</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  279</span>        filename = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  280</span>        a = np.memmap(filename, dtype=np.float32, shape=(3, 5), mode=<span class="stringliteral">&#39;w+&#39;</span>)</div>
<div class="line"><span class="lineno">  281</span>        a.fill(1.0)</div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  283</span>        p.map(inplace_double, [(a, (i, j), 1.0)</div>
<div class="line"><span class="lineno">  284</span>                               <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(a.shape[0])</div>
<div class="line"><span class="lineno">  285</span>                               <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(a.shape[1])])</div>
<div class="line"><span class="lineno">  286</span> </div>
<div class="line"><span class="lineno">  287</span>        assert_array_equal(a, 2 * np.ones(a.shape))</div>
<div class="line"><span class="lineno">  288</span> </div>
<div class="line"><span class="lineno">  289</span>        <span class="comment"># Open a copy-on-write view on the previous data</span></div>
<div class="line"><span class="lineno">  290</span>        b = np.memmap(filename, dtype=np.float32, shape=(5, 3), mode=<span class="stringliteral">&#39;c&#39;</span>)</div>
<div class="line"><span class="lineno">  291</span> </div>
<div class="line"><span class="lineno">  292</span>        p.map(inplace_double, [(b, (i, j), 2.0)</div>
<div class="line"><span class="lineno">  293</span>                               <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(b.shape[0])</div>
<div class="line"><span class="lineno">  294</span>                               <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(b.shape[1])])</div>
<div class="line"><span class="lineno">  295</span> </div>
<div class="line"><span class="lineno">  296</span>        <span class="comment"># Passing memmap instances to the pool should not trigger the creation</span></div>
<div class="line"><span class="lineno">  297</span>        <span class="comment"># of new files on the FS</span></div>
<div class="line"><span class="lineno">  298</span>        <span class="keyword">assert</span> os.listdir(pool_temp_folder) == []</div>
<div class="line"><span class="lineno">  299</span> </div>
<div class="line"><span class="lineno">  300</span>        <span class="comment"># the original data is untouched</span></div>
<div class="line"><span class="lineno">  301</span>        assert_array_equal(a, 2 * np.ones(a.shape))</div>
<div class="line"><span class="lineno">  302</span>        assert_array_equal(b, 2 * np.ones(b.shape))</div>
<div class="line"><span class="lineno">  303</span> </div>
<div class="line"><span class="lineno">  304</span>        <span class="comment"># readonly maps can be read but not updated</span></div>
<div class="line"><span class="lineno">  305</span>        c = np.memmap(filename, dtype=np.float32, shape=(10,), mode=<span class="stringliteral">&#39;r&#39;</span>,</div>
<div class="line"><span class="lineno">  306</span>                      offset=5 * 4)</div>
<div class="line"><span class="lineno">  307</span> </div>
<div class="line"><span class="lineno">  308</span>        <span class="keyword">with</span> raises(AssertionError):</div>
<div class="line"><span class="lineno">  309</span>            p.map(check_array, [(c, i, 3.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(c.shape[0])])</div>
<div class="line"><span class="lineno">  310</span> </div>
<div class="line"><span class="lineno">  311</span>        <span class="comment"># depending on the version of numpy one can either get a RuntimeError</span></div>
<div class="line"><span class="lineno">  312</span>        <span class="comment"># or a ValueError</span></div>
<div class="line"><span class="lineno">  313</span>        <span class="keyword">with</span> raises((RuntimeError, ValueError)):</div>
<div class="line"><span class="lineno">  314</span>            p.map(inplace_double, [(c, i, 2.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(c.shape[0])])</div>
<div class="line"><span class="lineno">  315</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  316</span>        <span class="comment"># Clean all filehandlers held by the pool</span></div>
<div class="line"><span class="lineno">  317</span>        p.terminate()</div>
<div class="line"><span class="lineno">  318</span>        del p</div>
<div class="line"><span class="lineno">  319</span> </div>
<div class="line"><span class="lineno">  320</span> </div>
<div class="line"><span class="lineno">  321</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  322</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  323</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  324</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="a2a2ea79ed9eeead00a1f4f102f72399e" name="a2a2ea79ed9eeead00a1f4f102f72399e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2a2ea79ed9eeead00a1f4f102f72399e">&#9670;&#160;</a></span>test_pool_with_memmap_array_view()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_pool_with_memmap_array_view </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that subprocess can access and update shared memory array</pre> <div class="fragment"><div class="line"><span class="lineno">  325</span><span class="keyword">def </span>test_pool_with_memmap_array_view(factory, tmpdir):</div>
<div class="line"><span class="lineno">  326</span>    <span class="stringliteral">&quot;&quot;&quot;Check that subprocess can access and update shared memory array&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  327</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno">  328</span> </div>
<div class="line"><span class="lineno">  329</span>    <span class="comment"># Fork the subprocess before allocating the objects to be passed</span></div>
<div class="line"><span class="lineno">  330</span>    pool_temp_folder = tmpdir.mkdir(<span class="stringliteral">&#39;pool&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  331</span>    p = factory(10, max_nbytes=2, temp_folder=pool_temp_folder)</div>
<div class="line"><span class="lineno">  332</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  333</span> </div>
<div class="line"><span class="lineno">  334</span>        filename = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  335</span>        a = np.memmap(filename, dtype=np.float32, shape=(3, 5), mode=<span class="stringliteral">&#39;w+&#39;</span>)</div>
<div class="line"><span class="lineno">  336</span>        a.fill(1.0)</div>
<div class="line"><span class="lineno">  337</span> </div>
<div class="line"><span class="lineno">  338</span>        <span class="comment"># Create an ndarray view on the memmap instance</span></div>
<div class="line"><span class="lineno">  339</span>        a_view = np.asarray(a)</div>
<div class="line"><span class="lineno">  340</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> isinstance(a_view, np.memmap)</div>
<div class="line"><span class="lineno">  341</span>        <span class="keyword">assert</span> has_shareable_memory(a_view)</div>
<div class="line"><span class="lineno">  342</span> </div>
<div class="line"><span class="lineno">  343</span>        p.map(inplace_double, [(a_view, (i, j), 1.0)</div>
<div class="line"><span class="lineno">  344</span>                               <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(a.shape[0])</div>
<div class="line"><span class="lineno">  345</span>                               <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(a.shape[1])])</div>
<div class="line"><span class="lineno">  346</span> </div>
<div class="line"><span class="lineno">  347</span>        <span class="comment"># Both a and the a_view have been updated</span></div>
<div class="line"><span class="lineno">  348</span>        assert_array_equal(a, 2 * np.ones(a.shape))</div>
<div class="line"><span class="lineno">  349</span>        assert_array_equal(a_view, 2 * np.ones(a.shape))</div>
<div class="line"><span class="lineno">  350</span> </div>
<div class="line"><span class="lineno">  351</span>        <span class="comment"># Passing memmap array view to the pool should not trigger the</span></div>
<div class="line"><span class="lineno">  352</span>        <span class="comment"># creation of new files on the FS</span></div>
<div class="line"><span class="lineno">  353</span>        <span class="keyword">assert</span> os.listdir(pool_temp_folder) == []</div>
<div class="line"><span class="lineno">  354</span> </div>
<div class="line"><span class="lineno">  355</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno">  356</span>        p.terminate()</div>
<div class="line"><span class="lineno">  357</span>        del p</div>
<div class="line"><span class="lineno">  358</span> </div>
<div class="line"><span class="lineno">  359</span> </div>
<div class="line"><span class="lineno">  360</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  361</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  362</span><span class="preprocessor">@parametrize(&quot;backend&quot;, [&quot;multiprocessing&quot;, &quot;loky&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1cafded09be6cd4ae23b365fa987acf4" name="a1cafded09be6cd4ae23b365fa987acf4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1cafded09be6cd4ae23b365fa987acf4">&#9670;&#160;</a></span>test_resource_tracker_retries_when_permissionerror()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_resource_tracker_retries_when_permissionerror </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  154</span><span class="keyword">def </span>test_resource_tracker_retries_when_permissionerror(tmpdir):</div>
<div class="line"><span class="lineno">  155</span>    <span class="comment"># Test resource_tracker retry mechanism when unlinking memmaps.  See more</span></div>
<div class="line"><span class="lineno">  156</span>    <span class="comment"># thorough information in the ``unlink_file`` documentation of joblib.</span></div>
<div class="line"><span class="lineno">  157</span>    filename = tmpdir.join(<span class="stringliteral">&#39;test.mmap&#39;</span>).strpath</div>
<div class="line"><span class="lineno">  158</span>    cmd = <span class="stringliteral">&quot;&quot;&quot;if 1:</span></div>
<div class="line"><span class="lineno">  159</span><span class="stringliteral">    import os</span></div>
<div class="line"><span class="lineno">  160</span><span class="stringliteral">    import numpy as np</span></div>
<div class="line"><span class="lineno">  161</span><span class="stringliteral">    import time</span></div>
<div class="line"><span class="lineno">  162</span><span class="stringliteral">    from joblib.externals.loky.backend import resource_tracker</span></div>
<div class="line"><span class="lineno">  163</span><span class="stringliteral">    resource_tracker.VERBOSE = 1</span></div>
<div class="line"><span class="lineno">  164</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  165</span><span class="stringliteral">    # Start the resource tracker</span></div>
<div class="line"><span class="lineno">  166</span><span class="stringliteral">    resource_tracker.ensure_running()</span></div>
<div class="line"><span class="lineno">  167</span><span class="stringliteral">    time.sleep(1)</span></div>
<div class="line"><span class="lineno">  168</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  169</span><span class="stringliteral">    # Create a file containing numpy data</span></div>
<div class="line"><span class="lineno">  170</span><span class="stringliteral">    memmap = np.memmap(r&quot;{filename}&quot;, dtype=np.float64, shape=10, mode=&#39;w+&#39;)</span></div>
<div class="line"><span class="lineno">  171</span><span class="stringliteral">    memmap[:] = np.arange(10).astype(np.int8).data</span></div>
<div class="line"><span class="lineno">  172</span><span class="stringliteral">    memmap.flush()</span></div>
<div class="line"><span class="lineno">  173</span><span class="stringliteral">    assert os.path.exists(r&quot;{filename}&quot;)</span></div>
<div class="line"><span class="lineno">  174</span><span class="stringliteral">    del memmap</span></div>
<div class="line"><span class="lineno">  175</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  176</span><span class="stringliteral">    # Create a np.memmap backed by this file</span></div>
<div class="line"><span class="lineno">  177</span><span class="stringliteral">    memmap = np.memmap(r&quot;{filename}&quot;, dtype=np.float64, shape=10, mode=&#39;w+&#39;)</span></div>
<div class="line"><span class="lineno">  178</span><span class="stringliteral">    resource_tracker.register(r&quot;{filename}&quot;, &quot;file&quot;)</span></div>
<div class="line"><span class="lineno">  179</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  180</span><span class="stringliteral">    # Ask the resource_tracker to delete the file backing the np.memmap , this</span></div>
<div class="line"><span class="lineno">  181</span><span class="stringliteral">    # should raise PermissionError that the resource_tracker will log.</span></div>
<div class="line"><span class="lineno">  182</span><span class="stringliteral">    resource_tracker.maybe_unlink(r&quot;{filename}&quot;, &quot;file&quot;)</span></div>
<div class="line"><span class="lineno">  183</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  184</span><span class="stringliteral">    # Wait for the resource_tracker to process the maybe_unlink before cleaning</span></div>
<div class="line"><span class="lineno">  185</span><span class="stringliteral">    # up the memmap</span></div>
<div class="line"><span class="lineno">  186</span><span class="stringliteral">    time.sleep(2)</span></div>
<div class="line"><span class="lineno">  187</span><span class="stringliteral">    &quot;&quot;&quot;</span>.format(filename=filename)</div>
<div class="line"><span class="lineno">  188</span>    p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd], stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  189</span>                         stdout=subprocess.PIPE)</div>
<div class="line"><span class="lineno">  190</span>    p.wait()</div>
<div class="line"><span class="lineno">  191</span>    out, err = p.communicate()</div>
<div class="line"><span class="lineno">  192</span>    <span class="keyword">assert</span> p.returncode == 0</div>
<div class="line"><span class="lineno">  193</span>    <span class="keyword">assert</span> out == b<span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><span class="lineno">  194</span>    msg = <span class="stringliteral">&#39;tried to unlink {}, got PermissionError&#39;</span>.format(filename)</div>
<div class="line"><span class="lineno">  195</span>    <span class="keyword">assert</span> msg <span class="keywordflow">in</span> err.decode()</div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  199</span><span class="preprocessor">@with_multiprocessing</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a766889a41bcf3cefbac5524285d73b0e" name="a766889a41bcf3cefbac5524285d73b0e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a766889a41bcf3cefbac5524285d73b0e">&#9670;&#160;</a></span>test_resource_tracker_silent_when_reference_cycles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_resource_tracker_silent_when_reference_cycles </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  651</span><span class="keyword">def </span>test_resource_tracker_silent_when_reference_cycles(backend):</div>
<div class="line"><span class="lineno">  652</span>    <span class="comment"># There is a variety of reasons that can make joblib with loky backend</span></div>
<div class="line"><span class="lineno">  653</span>    <span class="comment"># output noisy warnings when a reference cycle is preventing a memmap from</span></div>
<div class="line"><span class="lineno">  654</span>    <span class="comment"># being garbage collected. Especially, joblib&#39;s main process finalizer</span></div>
<div class="line"><span class="lineno">  655</span>    <span class="comment"># deletes the temporary folder if it was not done before, which can</span></div>
<div class="line"><span class="lineno">  656</span>    <span class="comment"># interact badly with the resource_tracker. We don&#39;t risk leaking any</span></div>
<div class="line"><span class="lineno">  657</span>    <span class="comment"># resources, but this will likely make joblib output a lot of low-level</span></div>
<div class="line"><span class="lineno">  658</span>    <span class="comment"># confusing messages.</span></div>
<div class="line"><span class="lineno">  659</span>    <span class="comment">#</span></div>
<div class="line"><span class="lineno">  660</span>    <span class="comment"># This test makes sure that the resource_tracker is silent when a reference</span></div>
<div class="line"><span class="lineno">  661</span>    <span class="comment"># has been collected concurrently on non-Windows platforms.</span></div>
<div class="line"><span class="lineno">  662</span>    <span class="comment">#</span></div>
<div class="line"><span class="lineno">  663</span>    <span class="comment"># Note that the script in ``cmd`` is the exact same script as in</span></div>
<div class="line"><span class="lineno">  664</span>    <span class="comment"># test_permission_error_windows_reference_cycle.</span></div>
<div class="line"><span class="lineno">  665</span>    <span class="keywordflow">if</span> backend == <span class="stringliteral">&quot;loky&quot;</span> <span class="keywordflow">and</span> sys.platform.startswith(<span class="stringliteral">&#39;win&#39;</span>):</div>
<div class="line"><span class="lineno">  666</span>        <span class="comment"># XXX: on Windows, reference cycles can delay timely garbage collection</span></div>
<div class="line"><span class="lineno">  667</span>        <span class="comment"># and make it impossible to properly delete the temporary folder in the</span></div>
<div class="line"><span class="lineno">  668</span>        <span class="comment"># main process because of permission errors.</span></div>
<div class="line"><span class="lineno">  669</span>        pytest.xfail(</div>
<div class="line"><span class="lineno">  670</span>            <span class="stringliteral">&quot;The temporary folder cannot be deleted on Windows in the &quot;</span></div>
<div class="line"><span class="lineno">  671</span>            <span class="stringliteral">&quot;presence of a reference cycle&quot;</span></div>
<div class="line"><span class="lineno">  672</span>        )</div>
<div class="line"><span class="lineno">  673</span> </div>
<div class="line"><span class="lineno">  674</span>    cmd = <span class="stringliteral">&quot;&quot;&quot;if 1:</span></div>
<div class="line"><span class="lineno">  675</span><span class="stringliteral">        import numpy as np</span></div>
<div class="line"><span class="lineno">  676</span><span class="stringliteral">        from joblib import Parallel, delayed</span></div>
<div class="line"><span class="lineno">  677</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  678</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  679</span><span class="stringliteral">        data = np.random.rand(int(2e6)).reshape((int(1e6), 2))</span></div>
<div class="line"><span class="lineno">  680</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  681</span><span class="stringliteral">        # Build a complex cyclic reference that is likely to delay garbage</span></div>
<div class="line"><span class="lineno">  682</span><span class="stringliteral">        # collection of the memmapped array in the worker processes.</span></div>
<div class="line"><span class="lineno">  683</span><span class="stringliteral">        first_list = current_list = [data]</span></div>
<div class="line"><span class="lineno">  684</span><span class="stringliteral">        for i in range(10):</span></div>
<div class="line"><span class="lineno">  685</span><span class="stringliteral">            current_list = [current_list]</span></div>
<div class="line"><span class="lineno">  686</span><span class="stringliteral">        first_list.append(current_list)</span></div>
<div class="line"><span class="lineno">  687</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  688</span><span class="stringliteral">        if __name__ == &quot;__main__&quot;:</span></div>
<div class="line"><span class="lineno">  689</span><span class="stringliteral">            results = Parallel(n_jobs=2, backend=&quot;{b}&quot;)(</span></div>
<div class="line"><span class="lineno">  690</span><span class="stringliteral">                delayed(len)(current_list) for i in range(10))</span></div>
<div class="line"><span class="lineno">  691</span><span class="stringliteral">            assert results == [1] * 10</span></div>
<div class="line"><span class="lineno">  692</span><span class="stringliteral">    &quot;&quot;&quot;</span>.format(b=backend)</div>
<div class="line"><span class="lineno">  693</span>    p = subprocess.Popen([sys.executable, <span class="stringliteral">&#39;-c&#39;</span>, cmd], stderr=subprocess.PIPE,</div>
<div class="line"><span class="lineno">  694</span>                         stdout=subprocess.PIPE)</div>
<div class="line"><span class="lineno">  695</span>    p.wait()</div>
<div class="line"><span class="lineno">  696</span>    out, err = p.communicate()</div>
<div class="line"><span class="lineno">  697</span>    out = out.decode()</div>
<div class="line"><span class="lineno">  698</span>    err = err.decode()</div>
<div class="line"><span class="lineno">  699</span>    <span class="keyword">assert</span> p.returncode == 0, out + <span class="stringliteral">&quot;\n\n&quot;</span> + err</div>
<div class="line"><span class="lineno">  700</span>    <span class="keyword">assert</span> <span class="stringliteral">&quot;resource_tracker&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> err, err</div>
<div class="line"><span class="lineno">  701</span> </div>
<div class="line"><span class="lineno">  702</span> </div>
<div class="line"><span class="lineno">  703</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno">  704</span><span class="preprocessor">@with_multiprocessing</span></div>
<div class="line"><span class="lineno">  705</span><span class="preprocessor">@parametrize</span>(<span class="stringliteral">&quot;factory&quot;</span>, [MemmappingPool, TestExecutor.get_memmapping_executor],</div>
<div class="line"><span class="lineno">  706</span>             ids=[<span class="stringliteral">&quot;multiprocessing&quot;</span>, <span class="stringliteral">&quot;loky&quot;</span>])</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3bf63d1d870a91751b4c3ed04dc84ee5" name="a3bf63d1d870a91751b4c3ed04dc84ee5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3bf63d1d870a91751b4c3ed04dc84ee5">&#9670;&#160;</a></span>test_weak_array_key_map()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_weak_array_key_map </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1080</span><span class="keyword">def </span>test_weak_array_key_map():</div>
<div class="line"><span class="lineno"> 1081</span> </div>
<div class="line"><span class="lineno"> 1082</span>    <span class="keyword">def </span>assert_empty_after_gc_collect(container, retries=100):</div>
<div class="line"><span class="lineno"> 1083</span>        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(retries):</div>
<div class="line"><span class="lineno"> 1084</span>            <span class="keywordflow">if</span> len(container) == 0:</div>
<div class="line"><span class="lineno"> 1085</span>                <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno"> 1086</span>            gc.collect()</div>
<div class="line"><span class="lineno"> 1087</span>            sleep(.1)</div>
<div class="line"><span class="lineno"> 1088</span>        <span class="keyword">assert</span> len(container) == 0</div>
<div class="line"><span class="lineno"> 1089</span> </div>
<div class="line"><span class="lineno"> 1090</span>    a = np.ones(42)</div>
<div class="line"><span class="lineno"> 1091</span>    m = _WeakArrayKeyMap()</div>
<div class="line"><span class="lineno"> 1092</span>    m.set(a, <span class="stringliteral">&#39;a&#39;</span>)</div>
<div class="line"><span class="lineno"> 1093</span>    <span class="keyword">assert</span> m.get(a) == <span class="stringliteral">&#39;a&#39;</span></div>
<div class="line"><span class="lineno"> 1094</span> </div>
<div class="line"><span class="lineno"> 1095</span>    b = a</div>
<div class="line"><span class="lineno"> 1096</span>    <span class="keyword">assert</span> m.get(b) == <span class="stringliteral">&#39;a&#39;</span></div>
<div class="line"><span class="lineno"> 1097</span>    m.set(b, <span class="stringliteral">&#39;b&#39;</span>)</div>
<div class="line"><span class="lineno"> 1098</span>    <span class="keyword">assert</span> m.get(a) == <span class="stringliteral">&#39;b&#39;</span></div>
<div class="line"><span class="lineno"> 1099</span> </div>
<div class="line"><span class="lineno"> 1100</span>    del a</div>
<div class="line"><span class="lineno"> 1101</span>    gc.collect()</div>
<div class="line"><span class="lineno"> 1102</span>    <span class="keyword">assert</span> len(m._data) == 1</div>
<div class="line"><span class="lineno"> 1103</span>    <span class="keyword">assert</span> m.get(b) == <span class="stringliteral">&#39;b&#39;</span></div>
<div class="line"><span class="lineno"> 1104</span> </div>
<div class="line"><span class="lineno"> 1105</span>    del b</div>
<div class="line"><span class="lineno"> 1106</span>    assert_empty_after_gc_collect(m._data)</div>
<div class="line"><span class="lineno"> 1107</span> </div>
<div class="line"><span class="lineno"> 1108</span>    c = np.ones(42)</div>
<div class="line"><span class="lineno"> 1109</span>    m.set(c, <span class="stringliteral">&#39;c&#39;</span>)</div>
<div class="line"><span class="lineno"> 1110</span>    <span class="keyword">assert</span> len(m._data) == 1</div>
<div class="line"><span class="lineno"> 1111</span>    <span class="keyword">assert</span> m.get(c) == <span class="stringliteral">&#39;c&#39;</span></div>
<div class="line"><span class="lineno"> 1112</span> </div>
<div class="line"><span class="lineno"> 1113</span>    <span class="keyword">with</span> raises(KeyError):</div>
<div class="line"><span class="lineno"> 1114</span>        m.get(np.ones(42))</div>
<div class="line"><span class="lineno"> 1115</span> </div>
<div class="line"><span class="lineno"> 1116</span>    del c</div>
<div class="line"><span class="lineno"> 1117</span>    assert_empty_after_gc_collect(m._data)</div>
<div class="line"><span class="lineno"> 1118</span> </div>
<div class="line"><span class="lineno"> 1119</span>    <span class="comment"># Check that creating and dropping numpy arrays with potentially the same</span></div>
<div class="line"><span class="lineno"> 1120</span>    <span class="comment"># object id will not cause the map to get confused.</span></div>
<div class="line"><span class="lineno"> 1121</span>    <span class="keyword">def </span>get_set_get_collect(m, i):</div>
<div class="line"><span class="lineno"> 1122</span>        a = np.ones(42)</div>
<div class="line"><span class="lineno"> 1123</span>        <span class="keyword">with</span> raises(KeyError):</div>
<div class="line"><span class="lineno"> 1124</span>            m.get(a)</div>
<div class="line"><span class="lineno"> 1125</span>        m.set(a, i)</div>
<div class="line"><span class="lineno"> 1126</span>        <span class="keyword">assert</span> m.get(a) == i</div>
<div class="line"><span class="lineno"> 1127</span>        <span class="keywordflow">return</span> id(a)</div>
<div class="line"><span class="lineno"> 1128</span> </div>
<div class="line"><span class="lineno"> 1129</span>    unique_ids = set([get_set_get_collect(m, i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1000)])</div>
<div class="line"><span class="lineno"> 1130</span>    <span class="keywordflow">if</span> platform.python_implementation() == <span class="stringliteral">&#39;CPython&#39;</span>:</div>
<div class="line"><span class="lineno"> 1131</span>        <span class="comment"># On CPython (at least) the same id is often reused many times for the</span></div>
<div class="line"><span class="lineno"> 1132</span>        <span class="comment"># temporary arrays created under the local scope of the</span></div>
<div class="line"><span class="lineno"> 1133</span>        <span class="comment"># get_set_get_collect function without causing any spurious lookups /</span></div>
<div class="line"><span class="lineno"> 1134</span>        <span class="comment"># insertions in the map.</span></div>
<div class="line"><span class="lineno"> 1135</span>        <span class="keyword">assert</span> len(unique_ids) &lt; 100</div>
<div class="line"><span class="lineno"> 1136</span> </div>
<div class="line"><span class="lineno"> 1137</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a995dfee08b173f64d84af9303cb1b177" name="a995dfee08b173f64d84af9303cb1b177"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a995dfee08b173f64d84af9303cb1b177">&#9670;&#160;</a></span>test_weak_array_key_map_no_pickling()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_weak_array_key_map_no_pickling </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1138</span><span class="keyword">def </span>test_weak_array_key_map_no_pickling():</div>
<div class="line"><span class="lineno"> 1139</span>    m = _WeakArrayKeyMap()</div>
<div class="line"><span class="lineno"> 1140</span>    <span class="keyword">with</span> raises(pickle.PicklingError):</div>
<div class="line"><span class="lineno"> 1141</span>        pickle.dumps(m)</div>
<div class="line"><span class="lineno"> 1142</span> </div>
<div class="line"><span class="lineno"> 1143</span> </div>
<div class="line"><span class="lineno"> 1144</span><span class="preprocessor">@with_numpy</span></div>
<div class="line"><span class="lineno"> 1145</span><span class="preprocessor">@with_multiprocessing</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a7606e872d878c92b14a9a70faf5ad258" name="a7606e872d878c92b14a9a70faf5ad258"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7606e872d878c92b14a9a70faf5ad258">&#9670;&#160;</a></span>test_workaround_against_bad_memmap_with_copied_buffers()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">joblib.test.test_memmapping.test_workaround_against_bad_memmap_with_copied_buffers </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>factory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tmpdir</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Check that memmaps with a bad buffer are returned as regular arrays

Unary operations and ufuncs on memmap instances return a new memmap
instance with an in-memory buffer (probably a numpy bug).
</pre> <div class="fragment"><div class="line"><span class="lineno">  993</span><span class="keyword">def </span>test_workaround_against_bad_memmap_with_copied_buffers(factory, tmpdir):</div>
<div class="line"><span class="lineno">  994</span>    <span class="stringliteral">&quot;&quot;&quot;Check that memmaps with a bad buffer are returned as regular arrays</span></div>
<div class="line"><span class="lineno">  995</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  996</span><span class="stringliteral">    Unary operations and ufuncs on memmap instances return a new memmap</span></div>
<div class="line"><span class="lineno">  997</span><span class="stringliteral">    instance with an in-memory buffer (probably a numpy bug).</span></div>
<div class="line"><span class="lineno">  998</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  999</span>    assert_array_equal = np.testing.assert_array_equal</div>
<div class="line"><span class="lineno"> 1000</span> </div>
<div class="line"><span class="lineno"> 1001</span>    p = factory(3, max_nbytes=10, temp_folder=tmpdir.strpath)</div>
<div class="line"><span class="lineno"> 1002</span>    <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno"> 1003</span>        <span class="comment"># Send a complex, large-ish view on a array that will be converted to</span></div>
<div class="line"><span class="lineno"> 1004</span>        <span class="comment"># a memmap in the worker process</span></div>
<div class="line"><span class="lineno"> 1005</span>        a = np.asarray(np.arange(6000).reshape((1000, 2, 3)),</div>
<div class="line"><span class="lineno"> 1006</span>                       order=<span class="stringliteral">&#39;F&#39;</span>)[:, :1, :]</div>
<div class="line"><span class="lineno"> 1007</span> </div>
<div class="line"><span class="lineno"> 1008</span>        <span class="comment"># Call a non-inplace multiply operation on the worker and memmap and</span></div>
<div class="line"><span class="lineno"> 1009</span>        <span class="comment"># send it back to the parent.</span></div>
<div class="line"><span class="lineno"> 1010</span>        b = p.apply_async(_worker_multiply, args=(a, 3)).get()</div>
<div class="line"><span class="lineno"> 1011</span>        <span class="keyword">assert</span> <span class="keywordflow">not</span> has_shareable_memory(b)</div>
<div class="line"><span class="lineno"> 1012</span>        assert_array_equal(b, 3 * a)</div>
<div class="line"><span class="lineno"> 1013</span>    <span class="keywordflow">finally</span>:</div>
<div class="line"><span class="lineno"> 1014</span>        p.terminate()</div>
<div class="line"><span class="lineno"> 1015</span>        del p</div>
<div class="line"><span class="lineno"> 1016</span> </div>
<div class="line"><span class="lineno"> 1017</span> </div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
